sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Select","sap/ui/core/Item","sap/m/Input","sap/m/DatePicker","sap/m/Button","sap/m/Dialog","sap/m/Text","sap/m/Label","sap/ui/layout/form/SimpleForm","sap/m/ToolbarSpacer","sap/m/Toolbar","sap/ui/model/odata/v2/ODataModel","sap/m/VBox","sap/m/ComboBox","sap/ui/core/BusyIndicator"],function(e,t,a,r,s,o,n,i,l,d,c,u,m,g,p,y,h,f,D,v,w,I){"use strict";return e.extend("admin.controller.Admin",{onInit:function(){var e=new a({users:[],projects:[],projectHours:[],managerTeams:[],projectDurations:[],selectedEmployee:"",selectedDate:new Date,currentWeekStart:this._getWeekStart(new Date),weekDays:[],timesheetEntries:[],employeeProjects:[],weekDates:{},overallProgress:{totalBookedHours:0,totalAllocatedHours:0,totalRemainingHours:0,averageUtilization:0}});this.getView().setModel(e);this._loadEmployees();this._loadProjects();this._loadOverallProgress();this._initializeTimesheet();var t=localStorage.getItem("selectedEmployeeId");if(t){e.setProperty("/selectedEmployee",t);var r=e.getProperty("/currentWeekStart");var s=this._getWeekEnd(r);this._loadAdminTimesheetData(t,r,s)}this.getView().attachModelContextChange(function(){var e=this.getView().getModel();var t=e.getProperty("/selectedEmployee");var a=this.byId("employeeList");if(a&&t){var r=a.getItems();for(var s=0;s<r.length;s++){var o=r[s];var n=o.getBindingContext();if(n&&n.getProperty("userId")===t){a.setSelectedItem(o);break}}}}.bind(this))},onEmployeeListSelect:function(e){var t=e.getParameter("listItem");var a=t.getBindingContext();var r=a.getProperty("userId");var s=this.getView().getModel();s.setProperty("/selectedEmployee",r);localStorage.setItem("selectedEmployeeId",r);var o=s.getProperty("/currentWeekStart");var n=this._getWeekEnd(o);this._loadAdminTimesheetData(r,o,n)},onSeeMoreEmployees:function(){var e=this.getView().getModel();var t=e.getProperty("/visibleItems")||10;var a=e.getProperty("/totalUsers");t=Math.min(t+10,a);e.setProperty("/visibleItems",t);e.setProperty("/showSeeMore",t<a)},onLogoutPress:function(){var e=this;s.confirm("Are you sure you want to logout?",{title:"Confirm Logout",icon:s.Icon.QUESTION,actions:[s.Action.OK,s.Action.CANCEL],emphasizedAction:s.Action.OK,onClose:function(t){if(t===s.Action.OK){e._performLogout()}}})},_performLogout:function(){I.show(0);try{localStorage.removeItem("selectedEmployeeId");localStorage.clear();sessionStorage.clear();var e=this.getView().getModel();if(e){e.setData({users:[],projects:[],projectHours:[],managerTeams:[],projectDurations:[],selectedEmployee:"",selectedDate:new Date,currentWeekStart:this._getWeekStart(new Date),weekDays:[],timesheetEntries:[],employeeProjects:[],weekDates:{},overallProgress:{totalBookedHours:0,totalAllocatedHours:0,totalRemainingHours:0,averageUtilization:0}})}t.show("Logged out successfully");var a=this;setTimeout(function(){var e=a.getOwnerComponent().getRouter();if(e){e.navTo("RouteLogin",{},true)}else{window.location.href="/index.html"}I.hide()},1e3)}catch(e){console.error("Error during logout:",e);I.hide();t.show("Error during logout. Please try again.")}},onAnalyticsPress:function(){var e=this;if(!this._oAnalyticsDialog){var t=new sap.m.VBox({items:[new sap.m.Title({text:"Progress Reports:"}).addStyleClass("sapUiSmallMarginTop sapUiSmallMarginBottom sapUiSmallMarginBegin"),new sap.m.VBox(this.createId("projectListContainer")).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd sapUiTinyMarginBottom")]});var a=new sap.m.ScrollContainer({width:"100%",height:"100%",vertical:true,content:[t]});this._oAnalyticsDialog=new sap.m.Dialog({title:"Project Progress Summary",icon:"sap-icon://message-information",type:"Message",contentWidth:"420px",contentHeight:"70vh",stretch:sap.ui.Device.system.phone,verticalScrolling:false,content:[a],beginButton:new sap.m.Button({text:"OK",type:"Emphasized",press:function(){e._oAnalyticsDialog.close()}})});this.getView().addDependent(this._oAnalyticsDialog)}this._oAnalyticsDialog.open();var r=this.byId("projectListContainer");r.removeAllItems();r.addItem(new sap.m.BusyIndicator({size:"2rem"}).addStyleClass("sapUiMediumMargin"));var s=this.getOwnerComponent().getModel("adminService");s.read("/Projects",{success:function(e){var t=e.results||[];r.removeAllItems();if(t.length===0){r.addItem(new sap.m.Text({text:"No projects found."}));return}t.forEach(function(e,a){var s=e.projectName||"Unnamed Project";var o=e.startDate?new Date(e.startDate).toLocaleDateString("en-GB"):"";var n=e.endDate?new Date(e.endDate).toLocaleDateString("en-GB"):"";var i=e.status||"Draft";var l=e.usedHours||0;var d=new sap.m.VBox({items:[new sap.m.Title({text:"Project: "+s,level:"H6"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.FormattedText({htmlText:"<strong>Total Hours Worked:</strong> "+l+"<br>"+"<strong>Start Date:</strong> "+o+"<br>"+"<strong>End Date:</strong> "+n+"<br>"+"<strong>Status:</strong> "+i})]}).addStyleClass("sapUiSmallMarginBottom sapUiTinyMarginBeginEnd");r.addItem(d);if(a<t.length-1){r.addItem(new sap.m.HBox({height:"1px"}).addStyleClass("separatorLine"))}})},error:function(){r.removeAllItems();r.addItem(new sap.m.MessageStrip({text:"Failed to load project data.",type:"Error",showIcon:true}))}})},onNotificationPress:function(){if(!this._oNotificationDialog){this._oNotificationDialog=new sap.m.Dialog({title:"Notifications",contentWidth:"80%",contentHeight:"75vh",stretch:sap.ui.Device.system.phone,content:new sap.m.List({id:this.createId("notificationList"),noDataText:"No notifications found",mode:sap.m.ListMode.None,items:{path:"/notifications",template:new sap.m.StandardListItem({title:"{title}",description:"{message}",info:"{createdAt}",infoState:"{= ${read} ? 'Success' : 'Warning' }",icon:"{= ${read} ? 'sap-icon://message-success' : 'sap-icon://message-information' }"})}}),beginButton:new sap.m.Button({text:"Close",press:function(){this._oNotificationDialog.close()}.bind(this)}),afterClose:function(){}});this.getView().addDependent(this._oNotificationDialog)}this._oNotificationDialog.open();this.byId("notificationList").setBusy(true);var e=this.getOwnerComponent().getModel("adminService");e.read("/Notifications",{success:function(e){var t=e.results||e.value||[];t.sort(function(e,t){return new Date(t.createdAt)-new Date(e.createdAt)});t.forEach(function(e){if(e.createdAt){var t=new Date(e.createdAt);e.createdAt=t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}e.title=e.title||"Notification";e.message=e.message||"";e.read=e.read===true});var a=new sap.ui.model.json.JSONModel({notifications:t});this.byId("notificationList").setModel(a);this.byId("notificationList").setBusy(false)}.bind(this),error:function(e){this.byId("notificationList").setBusy(false);sap.m.MessageToast.show("Error loading Notifications: "+(e.message||"Unknown error"))}.bind(this)})},_loadOverallProgress:function(){var e=this.getOwnerComponent().getModel("adminService");var a=this.getView().getModel();I.show(0);e.read("/OverallProgressReport",{success:function(e){I.hide();var t=e.results||[];var r={};t.forEach(function(e){var t=e.projectID||"unknown";var a=e.projectName||"Unknown Project";var s=parseFloat(e.allocatedHours)||0;var o=parseFloat(e.totalBookedHours)||0;var n=o>=2?Math.round(o):0;var i=s-n;if(!r[t]||s>(r[t].allocatedHours||0)){r[t]={project:a,allocatedHours:s,bookedHours:n,remainingHours:i>0?i:0,projectID:t,activityName:e.activityName,budget:e.budget,employeeID:e.employeeID,employeeName:e.employeeName,managerID:e.managerID,managerName:e.managerName,status:e.status,task:e.task}}});var s=Object.keys(r).map(function(e){return r[e]});s.sort(function(e,t){return e.project.localeCompare(t.project)});a.setProperty("/projectHours",s);var o=s.reduce((e,t)=>e+t.allocatedHours,0);var n=s.reduce((e,t)=>e+t.bookedHours,0);var i=o-n;var l=o>0?Math.round(n/o*100):0;a.setProperty("/overallProgress",{totalAllocatedHours:o,totalBookedHours:n,totalRemainingHours:i,averageUtilization:l});a.refresh(true)},error:function(e){I.hide();console.error("Error loading OverallProgressReport:",e);t.show("Failed to load project analytics data");a.setProperty("/projectHours",[]);a.setProperty("/overallProgress",{totalAllocatedHours:0,totalBookedHours:0,totalRemainingHours:0,averageUtilization:0})}})},onTaskDetailPress:function(e){try{var t=e.getSource();var a=t.getBindingContext();if(!a){sap.m.MessageToast.show("Unable to get binding context");return}var r=a.getObject();var s=this.getView().getModel();var o=this._getWeekDates();if(!o){sap.m.MessageToast.show("Week dates not available");return}r.dailyComments=r.dailyComments||{};var n=this;var i=[{name:"Monday",hours:r.monday||0,comment:r.mondayTaskDetails||"No task details",date:n._formatDateForDisplay(o.monday)},{name:"Tuesday",hours:r.tuesday||0,comment:r.tuesdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.tuesday)},{name:"Wednesday",hours:r.wednesday||0,comment:r.wednesdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.wednesday)},{name:"Thursday",hours:r.thursday||0,comment:r.thursdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.thursday)},{name:"Friday",hours:r.friday||0,comment:r.fridayTaskDetails||"No task details",date:n._formatDateForDisplay(o.friday)},{name:"Saturday",hours:r.saturday||0,comment:r.saturdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.saturday)},{name:"Sunday",hours:r.sunday||0,comment:r.sundayTaskDetails||"No task details",date:n._formatDateForDisplay(o.sunday)}];var l=function(e){if(e===0){return"tsHoursRed"}else if(e>0&&e<8){return"tsHoursOrange"}else if(e>=8&&e<=15){return"tsHoursGreen"}return""};var d=i.map(function(e,t){return new sap.m.VBox({width:"100%",items:[new sap.m.HBox({justifyContent:"SpaceBetween",alignItems:"Center",items:[new sap.m.VBox({items:[new sap.m.Text({text:e.name,design:"Bold"}).addStyleClass("tsDayName"),new sap.m.Text({text:e.date,design:"Bold"}).addStyleClass("tsDayDate")]}),new sap.m.HBox({alignItems:"Center",items:[new sap.m.Text({text:"Hours:",design:"Bold"}).addStyleClass("tsHoursLabel"),new sap.m.Text({text:`${e.hours.toFixed(2)}`,design:"Bold"}).addStyleClass(l(e.hours))]})]}).addStyleClass("tsDayHeader"),new sap.m.HBox({width:"100%",class:"sapUiTinyMarginTopBottom",items:[new sap.m.VBox({width:"100%",items:[new sap.m.Text({text:"Task Details:",design:"Bold"}).addStyleClass("tsTaskDetailsLabel"),new sap.m.Text({text:e.comment,wrapping:true}).addStyleClass("tsTaskDetails")]})]}),...t<i.length-1?[new sap.m.HBox({height:"1px",class:"tsSeparator sapUiTinyMarginTopBottom"})]:[]]}).addStyleClass("tsDayCard")});var c=new sap.m.Dialog({title:"Week Task Details",contentWidth:"400px",contentHeight:"70vh",stretchOnPhone:true,content:new sap.m.ScrollContainer({vertical:true,horizontal:false,height:"100%",content:new sap.m.VBox({items:d,class:"sapUiResponsiveMargin"})}),endButton:new sap.m.Button({text:"Close",press:function(){c.close()}}),afterClose:function(){c.destroy()}}).addStyleClass("tsTaskDetailDialog");var u=`\n      .tsTaskDetailDialog {\n        border-radius: 8px;\n        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);\n      }\n      \n      .tsDayCard {\n        background-color: #f8f9fa;\n        border-radius: 6px;\n        padding: 12px;\n        margin-bottom: 10px;\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n      }\n      \n      .tsDayHeader {\n        padding-bottom: 8px;\n        border-bottom: 1px solid #e0e0e0;\n      }\n      \n      .tsDayName {\n        font-size: 16px;\n        color: #333333;\n      }\n      \n      .tsDayDate {\n        font-size: 14px;\n        color: #666666;\n      }\n      \n      .tsHoursLabel {\n        font-size: 14px;\n        color: #666666;\n        margin-right: 5px;\n      }\n      \n      .tsHoursRed {\n        color: #e74c3c;\n        font-size: 16px;\n      }\n      \n      .tsHoursOrange {\n        color: #f39c12;\n        font-size: 16px;\n      }\n      \n      .tsHoursGreen {\n        color: #27ae60;\n        font-size: 16px;\n      }\n      \n      .tsTaskDetailsLabel {\n        font-size: 14px;\n        color: #666666;\n        margin-bottom: 4px;\n      }\n      \n      .tsTaskDetails {\n        font-size: 14px;\n        color: #333333;\n        line-height: 1.4;\n      }\n      \n      .tsSeparator {\n        background-color: #e0e0e0;\n        margin: 10px 0;\n      }\n    `;if(!document.getElementById("taskDetailStyles")){var m=document.createElement("style");m.id="taskDetailStyles";m.innerHTML=u;document.head.appendChild(m)}this.getView().addDependent(c);c.open()}catch(e){console.error("Error in onTaskDetailPress:",e)}},_formatDateForDisplay:function(e){if(!e)return"";var t=new Date(e);var a={month:"short",day:"numeric",year:"numeric"};return t.toLocaleDateString("en-US",a)},_getWeekDates:function(){var e=this.getView().getModel();var t=new Date(e.getProperty("/currentWeekStart"));var a={monday:new Date(t),tuesday:new Date(t),wednesday:new Date(t),thursday:new Date(t),friday:new Date(t),saturday:new Date(t),sunday:new Date(t)};a.tuesday.setDate(a.tuesday.getDate()+1);a.wednesday.setDate(a.wednesday.getDate()+2);a.thursday.setDate(a.thursday.getDate()+3);a.friday.setDate(a.friday.getDate()+4);a.saturday.setDate(a.saturday.getDate()+5);a.sunday.setDate(a.sunday.getDate()+6);return a},_initializeTimesheet:function(){let e=this.getView().getModel();let t=new Date(e.getProperty("/currentWeekStart"));let a=[];for(let e=0;e<7;e++){let r=new Date(t);r.setDate(r.getDate()+e);a.push(this._formatDay(r))}e.setProperty("/weekDays",a);let r=this._getWeekEnd(t);let s=e.getProperty("/selectedEmployee");if(s){console.log("Loading timesheet for employee:",s);this._loadAdminTimesheetData(s,t,r)}},_formatDay:function(e){var t={month:"short",day:"numeric"};return e.toLocaleDateString("en-US",t)},_getWeekStart:function(e){var t=new Date(e);var a=t.getDay();var r=t.getDate()-a+(a===0?-6:1);return new Date(t.setDate(r))},_loadAdminTimesheetData:function(e,a,r){let s=this.getOwnerComponent().getModel("adminService");let i=this;let l=this.getView().getModel();I.show(0);let d=e=>{if(!e)return"";return new Date(e).toISOString().split("T")[0]};let c=d(a);let u=d(r);console.log("Loading timesheet data:",{employeeId:e,weekStart:c,weekEnd:u});let m=[new o("employeeEmpID",n.EQ,e),new o("weekStartDate",n.LE,u),new o("weekEndDate",n.GE,c)];s.read("/Timesheets",{filters:m,success:function(t){let a=t.results||[];let r=a.filter(t=>{if(t.employeeEmpID!==e){return false}let a=d(t.weekStartDate);let r=d(t.weekEndDate);return a<=u&&r>=c});console.log("Filtered entries:",r);let s=i._formatAdminTimesheet(r);l.setProperty("/timesheetEntries",s);let o=s.reduce((e,t)=>e+t.totalHours,0);l.setProperty("/totalWeekHours",o);console.log("Filtered Week Data",s);I.hide()},error:function(e){console.error("Error loading timesheet data:",e);t.show("Error loading timesheet data");I.hide()}})},_formatAdminTimesheet:function(e){return e.map(e=>{let t=e.projectName&&e.projectName.trim()!==""?e.projectName:e.nonProjectTypeName||"Non-Project";const a=e=>e?parseFloat(e):0;return{project:t,task:e.task||"",taskDetails:e.taskDetails||"",mondayTaskDetails:e.mondayTaskDetails||"",tuesdayTaskDetails:e.tuesdayTaskDetails||"",wednesdayTaskDetails:e.wednesdayTaskDetails||"",thursdayTaskDetails:e.thursdayTaskDetails||"",fridayTaskDetails:e.fridayTaskDetails||"",saturdayTaskDetails:e.saturdayTaskDetails||"",sundayTaskDetails:e.sundayTaskDetails||"",monday:a(e.mondayHours),tuesday:a(e.tuesdayHours),wednesday:a(e.wednesdayHours),thursday:a(e.thursdayHours),friday:a(e.fridayHours),saturday:a(e.saturdayHours),sunday:a(e.sundayHours),totalHours:a(e.mondayHours)+a(e.tuesdayHours)+a(e.wednesdayHours)+a(e.thursdayHours)+a(e.fridayHours)+a(e.saturdayHours)+a(e.sundayHours)}})},_loadTimesheetEntriesFromBackend:function(e){var a=this.getView().getModel();var r=this;var s=a.getProperty("/currentWeekStart");var i=this._formatDateForOData(s);var l=new Date(s);l.setDate(l.getDate()+6);var d=this._formatDateForOData(l);var c=this.getOwnerComponent().getModel("adminService");var u=[new o("employeeID",n.EQ,e),new o("date",n.BT,i,d)];c.read("/Timesheets",{filters:u,success:function(e){var t=e.results||[];var s=a.getProperty("/employeeProjects")||[];var o=[];var n={};t.forEach(function(e){var t=e.projectID;if(!n[t]){n[t]={projectId:t,project:e.projectName||"",task:e.task||"General",taskDetails:e.taskDetails||"",monday:"0.00",tuesday:"0.00",wednesday:"0.00",thursday:"0.00",friday:"0.00",saturday:"0.00",sunday:"0.00",totalHours:"0.00"}}var a=new Date(e.date);var s=a.getDay();var o=r._getDayName(s);if(o&&e.hours){n[t][o]=parseFloat(e.hours).toFixed(2)}});Object.keys(n).forEach(function(e){var t=n[e];var a=0;var r=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];for(var s=0;s<r.length;s++){var i=parseFloat(t[r[s]])||0;a+=i}t.totalHours=a.toFixed(2);o.push(t)});s.forEach(function(e){if(!n[e.projectId]){o.push({projectId:e.projectId,project:e.name,task:"General",taskDetails:"Work on "+e.name,monday:"0.00",tuesday:"0.00",wednesday:"0.00",thursday:"0.00",friday:"0.00",saturday:"0.00",sunday:"0.00",totalHours:"0.00"})}});a.setProperty("/timesheetEntries",o)},error:function(e){console.error("Error loading timesheet entries:",e);t.show("Error loading timesheet data");var r=a.getProperty("/employeeProjects")||[];var s=[];r.forEach(function(e){s.push({projectId:e.projectId,project:e.name,task:"General",taskDetails:"Work on "+e.name,monday:"0.00",tuesday:"0.00",wednesday:"0.00",thursday:"0.00",friday:"0.00",saturday:"0.00",sunday:"0.00",totalHours:"0.00"})});a.setProperty("/timesheetEntries",s)}})},_formatDateForOData:function(e){var t=(e.getMonth()+1).toString().padStart(2,"0");var a=e.getDate().toString().padStart(2,"0");return e.getFullYear()+"-"+t+"-"+a},_getDayName:function(e){switch(e){case 1:return"monday";case 2:return"tuesday";case 3:return"wednesday";case 4:return"thursday";case 5:return"friday";case 6:return"saturday";case 0:return"sunday";default:return null}},_loadEmployeeProjects:function(e){var t=this.getView().getModel();var a=t.getProperty("/projects")||[];var r=a.filter(function(t){return t.managerId===e||t.teamMembers&&t.teamMembers.includes(e)});t.setProperty("/employeeProjects",r)},onEmployeeChange:function(e){let t=this.getView().getModel();let a=e.getParameter("selectedItem")?e.getParameter("selectedItem").getKey():e.getSource().getSelectedKey();t.setProperty("/selectedEmployee",a);localStorage.setItem("selectedEmployeeId",a);var r=this.byId("employeeList");if(r){var s=r.getItems();for(var o=0;o<s.length;o++){var n=s[o];var i=n.getBindingContext();if(i&&i.getProperty("userId")===a){r.setSelectedItem(n);break}}}let l=t.getProperty("/currentWeekStart");let d=this._getWeekEnd(l);t.setProperty("/timesheetEntries",[]);t.setProperty("/totalWeekHours",0);this._loadAdminTimesheetData(a,l,d)},_getWeekEnd:function(e){let t=new Date(e);t.setDate(t.getDate()+6);return t},onHourButtonPress:function(e){try{var t=e.getSource();var a=t.getBindingContext();if(!a){sap.m.MessageToast.show("Unable to get binding context");return}var r=a.getObject();var s=this.getView().getModel();var o=s.getProperty("/weekDays")||[];var n=t.data("day");if(!n){var i=t.getBindingPath("text");if(i){n=i.toLowerCase()}else{sap.m.MessageToast.show("Unable to determine day");return}}var l=this._getDayIndex(n);var d=o[l]||this._getDefaultDate(l);var c=r[n]||0;var u=this._getWeekDates();var m=this._formatDateForDisplay(u[n]);if(!this._oHourEditDialog){var g=[];for(var p=0;p<=15;p++){g.push(new sap.ui.core.Item({key:p.toString(),text:p+" hour"+(p!==1?"s":"")}))}this._oHourEditDialog=new sap.m.Dialog({title:"Edit "+this._capitalize(n)+" Entry",contentWidth:"350px",titleAlignment:"Center",content:[new sap.m.VBox({items:[new sap.m.VBox({items:[new sap.m.Label({text:"Date:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:"{/editData/date}",editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Project:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:"{/editData/projectName}",editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Task",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:"{/editData/taskType}",editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Hours:",design:"Bold",required:true}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:"{/editData/hours}",editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Task Details:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.TextArea({value:"{/editData/taskDetails}",rows:4,width:"100%",editable:false})]})]}).addStyleClass("sapUiMediumMarginBeginEnd sapUiSmallMarginTopBottom")],beginButton:new sap.m.Button({text:"Close",type:"Emphasized",press:function(){this._oHourEditDialog.close()}.bind(this)})});this.getView().addDependent(this._oHourEditDialog)}var y=s.getProperty("/projects")||[];var h=r.project||"";if(r.projectId){var f=y.find(function(e){return e.projectId===r.projectId||e.ID===r.projectId});if(f){h=f.name||f.projectName}}var D=n+"TaskDetails";var v=r[D]||r.taskDetails||"";var w=new sap.ui.model.json.JSONModel({editData:{entryIndex:a.getPath().split("/")[2],entryId:r.ID,day:n,dayName:this._getDayDisplayName(n),date:m,projectName:h,projectId:r.projectId,taskType:r.task||"",hours:c>0?c.toString():"0",taskDetails:v}});this._oHourEditDialog.setModel(w);var I=this._getDayDisplayName(n);this._oHourEditDialog.setTitle("Edit "+I+" Entry");this._oHourEditDialog.open()}catch(e){console.error("Error in onHourButtonPress:",e);sap.m.MessageToast.show("Error opening edit dialog")}},_validateHours:function(e){var t=e.getSource().getValue();var a=this._oHourEditDialog.getModel();var r=a.getProperty("/editData");if(t===""||t===null||t===undefined){r.hoursState="Error"}else{var s=parseFloat(t);if(isNaN(s)||s<0||s>24){r.hoursState="Error"}else{r.hoursState="None"}}a.setProperty("/editData",r)},_saveHourEntry:function(){try{var e=this._oHourEditDialog.getModel();var t=e.getProperty("/editData");if(t.hoursState==="Error"||!t.hours||isNaN(t.hours)){sap.m.MessageToast.show("Please enter valid hours between 0 and 24");return}var a=parseFloat(t.hours);if(a<0||a>24){sap.m.MessageToast.show("Hours must be between 0 and 24");return}var r=this.getView().getModel();var s=r.getProperty("/timesheetEntries");var o=s[t.entryIndex];if(!o){sap.m.MessageToast.show("Error: Entry not found");return}o[t.day]=a;var n=t.day+"TaskDetails";o[n]=t.taskDetails;o.task=t.taskType;o.taskDetails=t.taskDetails;var i=0;var l=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];for(var d=0;d<l.length;d++){var c=parseFloat(o[l[d]])||0;i+=c}o.totalHours=i.toFixed(2);r.setProperty("/timesheetEntries",s);sap.m.MessageToast.show(t.dayName+" entry updated successfully");this._oHourEditDialog.close();this._saveTimesheetToBackend()}catch(e){console.error("Error saving hour entry:",e);sap.m.MessageToast.show("Error saving entry")}},_capitalize:function(e){if(!e)return"";return e.charAt(0).toUpperCase()+e.slice(1)},_getDayIndex:function(e){var t={monday:0,tuesday:1,wednesday:2,thursday:3,friday:4,saturday:5,sunday:6};return t[e]||0},_getDayDisplayName:function(e){var t={monday:"Monday",tuesday:"Tuesday",wednesday:"Wednesday",thursday:"Thursday",friday:"Friday",saturday:"Saturday",sunday:"Sunday"};return t[e]||"Day"},_getDefaultDate:function(e){var t=["Nov 17","Nov 18","Nov 19","Nov 20","Nov 21","Nov 22","Nov 23"];return t[e]||"Unknown Date"},onPreviousWeek:function(){let e=this.getView().getModel();let t=new Date(e.getProperty("/currentWeekStart"));if(isNaN(t)){console.error("Invalid week start:",e.getProperty("/currentWeekStart"));return}t.setDate(t.getDate()-7);e.setProperty("/currentWeekStart",t);e.setProperty("/selectedDate",t);let a=new Date(t);let r=this._getWeekEnd(a);this._updateWeekDays(a);let s=e.getProperty("/selectedEmployee");if(s){this._loadAdminTimesheetData(s,a,r)}},onCurrentWeek:function(){let e=this.getView().getModel();let t=this._getWeekStart(new Date);e.setProperty("/currentWeekStart",t);e.setProperty("/selectedDate",t);let a=this._getWeekEnd(t);this._updateWeekDays(t);let r=e.getProperty("/selectedEmployee");if(r){this._loadAdminTimesheetData(r,t,a)}},onNextWeek:function(){let e=this.getView().getModel();let t=new Date(e.getProperty("/currentWeekStart"));if(isNaN(t)){console.error("Invalid week start:",e.getProperty("/currentWeekStart"));return}t.setDate(t.getDate()+7);e.setProperty("/currentWeekStart",t);e.setProperty("/selectedDate",t);let a=new Date(t);let r=this._getWeekEnd(a);this._updateWeekDays(a);let s=e.getProperty("/selectedEmployee");if(s){this._loadAdminTimesheetData(s,a,r)}},onDatePickerChange:function(e){I.show(0);let a=e.getParameter("value");if(!a){I.hide();return}let r=new Date(a);if(isNaN(r.getTime())){I.hide();return}let s=this.getView().getModel();let o=this._getWeekStart(r);s.setProperty("/currentWeekStart",o);s.setProperty("/selectedDate",r);this._updateWeekDays(o);let n=this._getWeekEnd(o);console.log("DatePicker changed:",{selectedDate:a,dateValue:r,weekStart:o,weekEnd:n,formattedWeekStart:this._formatDateForOData(o),formattedWeekEnd:this._formatDateForOData(n)});let i=s.getProperty("/selectedEmployee");if(i){this._loadAdminTimesheetData(i,o,n)}else{t.show("Please select an employee first")}I.hide()},_updateWeekDays:function(e){let t=this.getView().getModel();let a=new Date(e);let r=[];for(let e=0;e<7;e++){let t=new Date(a);t.setDate(t.getDate()+e);r.push(this._formatDay(t))}t.setProperty("/weekDays",r)},onRecordTime:function(){var e=this.getView().getModel();var a=e.getProperty("/selectedEmployee");var r=e.getProperty("/timesheetEntries");var s=e.getProperty("/currentWeekStart");if(!a){t.show("Please select an employee first");return}this._saveTimesheetToBackend(a,r,s)},_saveTimesheetToBackend:function(e,a,r){var s=this.getOwnerComponent().getModel("adminService");var i=this;var l=new Date(r);l.setDate(l.getDate()+6);var d=this._formatDateForOData(r);var c=this._formatDateForOData(l);var u=[new o("employeeID",n.EQ,e),new o("date",n.BT,d,c)];s.read("/Timesheets",{filters:u,success:function(o){var n=o.results||[];var u=[];n.forEach(function(e){var t=new Promise(function(t,a){s.remove("/Timesheets('"+e.ID+"')",{success:t,error:a})});u.push(t)});Promise.all(u).then(function(){var o=[];var n=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];a.forEach(function(t){n.forEach(function(a,n){var l=parseFloat(t[a])||0;if(l>0){var u=new Date(r);u.setDate(u.getDate()+n);var m={employeeID:e,projectID:t.projectId,projectName:t.project,task:t.task,taskDetails:t[a+"TaskDetails"]||t.taskDetails||"",date:i._formatDateForOData(u),hours:l,weekStartDate:d,weekEndDate:c};var g=new Promise(function(e,t){s.create("/Timesheets",m,{success:e,error:t})});o.push(g)}})});Promise.all(o).then(function(){t.show("Timesheet recorded successfully for employee: "+e);i._loadAdminTimesheetData(e,r,l)}).catch(function(e){console.error("Error creating timesheet entries:",e);t.show("Error saving some timesheet entries")})}).catch(function(e){console.error("Error deleting existing timesheet entries:",e);t.show("Error updating timesheet entries")})},error:function(e){console.error("Error reading existing timesheet entries:",e);t.show("Error updating timesheet entries")}})},_generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,a=e=="x"?t:t&3|8;return a.toString(16)})},_loadEmployees:function(){var e=this.getOwnerComponent().getModel("adminService");var a=this;e.read("/Employees",{success:function(e){var r=e.value||e.results||[];console.log("Raw Employees Data from OData:",r);var s=a._formatEmployeeData(r);var o=["Employee","Manager"];var n=s.filter(e=>o.includes(e.roleName));var i=a.getView().getModel();i.setProperty("/users",n);if(s.length>0){let e=localStorage.getItem("selectedEmployeeId");let t=e||s[0].userId;i.setProperty("/selectedEmployee",t);let r=i.getProperty("/currentWeekStart");let o=a._getWeekEnd(r);a._loadAdminTimesheetData(t,r,o)}i.refresh(true);a._refreshAnalyticsData();t.show("Employees loaded successfully: "+s.length+" users")},error:function(e){console.error("Error loading employees:",e);t.show("Error loading employees data")}})},_loadProjects:function(){var e=this.getOwnerComponent().getModel("adminService");var a=this;e.read("/Projects",{success:function(e){var r=e.value||e.results||[];console.log("Raw Projects Data from OData:",r);var s=a._formatProjectData(r);console.log("Formatted Projects for UI:",s);var o=a.getView().getModel();o.setProperty("/projects",s);o.refresh(true);a._refreshAnalyticsData();t.show("Projects loaded successfully: "+s.length+" projects")},error:function(e){console.error("Error loading projects:",e);t.show("Error loading projects data")}})},_formatEmployeeData:function(e){let t=e.map(function(e){let t=e.roleName||e.Role||e.role||e.accessLevel||"Employee";t=t.toLowerCase().includes("admin")?"Admin":t.toLowerCase().includes("manager")?"Manager":"Employee";return{userId:e.employeeID||e.EmployeeID||e.ID,backendId:e.ID||e.id||"",firstName:e.firstName||e.FirstName||"",lastName:e.lastName||e.LastName||"",email:e.email||e.Email||"",role:t,roleName:t,managerId:e.managerID_ID||e.ManagerID||e.managerId||"",managerName:e.managerName||e.ManagerName||"",status:e.isActive?"Active":"Inactive"}});t.forEach(function(e){if(e.managerId){const a=t.find(t=>t.userId===e.managerId);if(a){e.managerName=a.firstName+" "+a.lastName}else if(!e.managerName){e.managerName="Unknown Manager"}}else{e.managerName=""}});return t},_formatProjectData:function(e){var t=this.getView().getModel();var a=t.getProperty("/users")||[];return e.map(e=>{console.log("Processing project:",e);var t=Number(e.budget)||0;var a=Number(e.allocatedHours)||0;var r=Number(e.usedHours)||0;var s=e.projectOwner_ID||e.managerId||"";var o=e.projectOwnerName||null;var n={projectId:e.projectID||e.ID,name:e.projectName||e.name||"Unknown Project",description:e.description||"",managerId:s,managerName:o,budget:t,allocatedHours:a,usedHours:r,startDate:e.startDate?new Date(e.startDate).toISOString().split("T")[0]:null,endDate:e.endDate?new Date(e.endDate).toISOString().split("T")[0]:null,status:e.status||"Active",client:e.client||"Internal",isBillable:e.isBillable!==undefined?e.isBillable:true,teamMembers:[]};console.log("Formatted project:",n);return n})},onAddUser:function(){this._loadUserDialog("create")},onEditUser:function(e){var t=e.getSource().getBindingContext().getObject();this._loadUserDialog("edit",t)},onToggleUserStatus:function(e){var t=e.getSource().getBindingContext().getObject();var a=this.getView().getModel();var r=a.getProperty("/users");var s=r.find(e=>e.userId===t.userId);if(s){s.status=s.status==="Active"?"Inactive":"Active";a.setProperty("/users",r);a.refresh(true);this._updateEmployeeInOData(s,false)}},_loadUserDialog:async function(e,t){const r=await this._loadAvailableManagers();const s=new a({mode:e,userData:t?JSON.parse(JSON.stringify(t)):{firstName:"",lastName:"",email:"",role:"",managerId:"",managerName:"",status:"Active"},availableManagers:r});if(!this._oUserDialog){this._oUserDialog=new m({title:e==="create"?"Create New User":"Edit User",contentWidth:"500px",content:[new y({layout:"ResponsiveGridLayout",editable:true,content:[new p({text:"First Name"}),new d({value:"{/userData/firstName}",required:true,placeholder:"Enter First Name"}),new p({text:"Last Name"}),new d({value:"{/userData/lastName}",required:true,placeholder:"Enter Last Name"}),new p({text:"Email"}),new d({value:"{/userData/email}",type:"Email",required:true,placeholder:"Enter Email"}),new p({text:"Role"}),new i({selectedKey:"{/userData/role}",placeholder:"Select Role",forceSelection:false,items:[new l({key:"Employee",text:"Employee"}),new l({key:"Manager",text:"Manager"}),new l({key:"Admin",text:"Admin"})]}),new p({text:"Manager"}),new i({selectedKey:"{/userData/managerId}",forceSelection:false,items:{path:"/availableManagers",template:new l({key:"{ID}",text:"{firstName} {lastName}"})},showSecondaryValues:true,change:function(e){const t=e.getSource().getSelectedItem();if(!t)return;const a=this.getParent().getParent().getParent();const r=a.getModel();const s=t.getBindingContext().getObject();r.setProperty("/userData/managerId",s.ID);r.setProperty("/userData/managerName",s.firstName+" "+s.lastName)}}),new p({text:"Status"}),new i({selectedKey:"{/userData/status}",items:[new l({key:"Active",text:"Active"}),new l({key:"Inactive",text:"Inactive"})]})]})],beginButton:new u({text:"Save",press:this.onSaveUser.bind(this)}),endButton:new u({text:"Cancel",press:this.onCancelUser.bind(this)})});this.getView().addDependent(this._oUserDialog)}this._oUserDialog.setModel(s);this._oUserDialog.open()},_loadAvailableManagers:function(){return new Promise((e,t)=>{const a=this.getOwnerComponent().getModel("adminService");a.read("/AvailableManagers",{success:function(t){const a=t.results||t.value||[];e(a)},error:function(e){console.error("Failed loading managers",e);t(e)}})})},_getManagersList:function(){var e=this.getView().getModel();var t=e.getProperty("/users");return t.filter(e=>e.role==="Manager"&&e.status==="Active").map(e=>({ID:e.backendId,firstName:e.firstName,lastName:e.lastName}))},onSaveUser:function(){var e=this._oUserDialog;var a=e.getModel();var r=JSON.parse(JSON.stringify(a.getProperty("/userData")));var s=a.getProperty("/mode");if(!r.firstName||!r.lastName||!r.email){t.show("Please fill in all required fields");return}var o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!o.test(r.email)){t.show("Please enter a valid email address");return}var n=this.getView().getModel();var i=n.getProperty("/users").slice();var l=i.some(e=>e.email===r.email&&(s==="create"||e.userId!==r.userId));if(l){t.show("Email address already exists");return}if(s==="edit"){var i=n.getProperty("/users");var d=i.findIndex(e=>e.userId===r.userId);if(d!==-1){i[d]={...i[d],firstName:r.firstName,lastName:r.lastName,email:r.email,role:r.role,roleName:r.roleName,managerId:r.managerId,status:r.status};let e=a.getProperty("/availableManagers");if(!r.managerId&&r.managerName){let t=e.find(e=>(e.firstName+" "+e.lastName).trim()===r.managerName.trim());if(t){r.managerId=t.ID}}n.setProperty("/users",i);n.refresh(true);t.show("User updated successfully in UI")}}else if(s==="create"){t.show("User added successfully in UI")}if(s==="create"){this._createEmployeeInOData(r,false)}else{this._updateEmployeeInOData(r,false)}e.close()},_createEmployeeInOData:function(e,a=true){var r=this.getOwnerComponent().getModel("adminService");var s=this;var o={firstName:e.firstName,lastName:e.lastName,email:e.email,roleName:e.role,managerID_ID:e.managerId||null,isActive:e.status==="Active"};console.log("Creating employee with payload:",o);r.create("/Employees",o,{success:function(e){t.show("User created successfully");let a=s.getView().getModel();let r=a.getProperty("/users")||[];const n=e.ID;const i=r.find(e=>e.backendId===o.managerID_ID);const l={backendId:n,userId:e.employeeID||n,firstName:o.firstName,lastName:o.lastName,email:o.email,role:o.roleName,roleName:o.roleName,managerId:o.managerID_ID,managerName:i?i.firstName+" "+i.lastName:"",status:o.isActive?"Active":"Inactive"};r.push(l);a.setProperty("/users",r)},error:function(e){console.error("Create failed:",e);t.show("Error creating user")}})},_updateEmployeeInOData:function(e,a=true){var r=this.getOwnerComponent().getModel("adminService");var s=this;this._getUserRoleIdByName(e.role).then(function(a){return s._getManagerEmployeeId(e.managerId).then(function(o){r.read("/Employees",{success:function(n){var i=n.results.find(t=>t.employeeID===e.userId);if(!i){t.show("Employee not found.");return}var l=i.ID;var d={firstName:e.firstName,lastName:e.lastName,email:e.email,userRole_ID:a,managerID_ID:o,managerName:e.managerName,isActive:e.status==="Active"};var c="/Employees('"+l+"')";r.update(c,d,{success:function(){t.show("User updated successfully.");var a=s.getView().getModel();var r=a.getProperty("/users");let o=r.findIndex(t=>t.userId===e.userId);if(o!==-1){r[o].firstName=e.firstName;r[o].lastName=e.lastName;r[o].email=e.email;r[o].role=e.role;r[o].roleName=e.role;r[o].managerId=e.managerId;r[o].managerName=e.managerName;r[o].status=e.status;r[o].backendId=l}a.setProperty("/users",r)}})}})})})},_getUserRoleIdByName:function(e){return new Promise((t,a)=>{var r=this.getOwnerComponent().getModel("adminService");r.read("/UserRoles",{success:function(r){if(!r.results)return a("No UserRoles found");let s=r.results.find(t=>t.roleName===e);if(!s)return a("Role not found: "+e);t(s.ID)},error:a})})},_getManagerEmployeeId:function(e){return new Promise((t,a)=>{var r=this.getOwnerComponent().getModel("adminService");r.read("/AvailableManagers",{success:function(a){let r=a.results||[];let s=r.find(t=>t.ID===e);if(!s){t(null);return}t(s.ID)},error:a})})},onCancelUser:function(){if(this._oUserDialog){this._oUserDialog.close()}},onAddProject:function(){this._loadProjectDialog("create")},onEditProject:function(e){var t=e.getSource().getBindingContext().getObject();this._loadProjectDialog("edit",t)},onDeleteProject:function(e){var t=e.getSource().getBindingContext().getObject();s.confirm("Are you sure you want to delete project '"+t.name+"'?",{title:"Delete Project",onClose:function(e){if(e===s.Action.OK){this._deleteProjectInOData(t)}}.bind(this)})},_loadProjectDialog:async function(e,t){const r=await this._loadAvailableManagers();var s=new a({mode:e,projectData:t?JSON.parse(JSON.stringify(t)):{ID:"",projectId:"",name:"",description:"",managerId:"",managerName:"",budget:0,allocatedHours:0,usedHours:0,startDate:(new Date).toISOString().split("T")[0],endDate:new Date((new Date).setFullYear((new Date).getFullYear()+1)).toISOString().split("T")[0],status:"Planning"},availableManagers:r});if(!this._oProjectDialog){this._oProjectDialog=new m({title:e==="create"?"Create Project":"Edit Project",contentWidth:"600px",content:[new y({editable:true,content:[new p({text:"Project Name"}),new d({value:"{/projectData/name}",required:true}),new p({text:"Project Manager"}),new i({selectedKey:"{/projectData/managerId}",items:{path:"/availableManagers",template:new sap.ui.core.Item({key:"{ID}",text:"{firstName} {lastName}"})},change:function(e){const t=e.getSource().getSelectedItem();const a=e.getSource().getSelectedKey();const r=t?t.getText():"";let o=s.getProperty("/projectData");o.managerId=a;o.managerName=r;s.setProperty("/projectData",o)}}),new p({text:"Budget ($)"}),new d({value:"{/projectData/budget}",type:"Number"}),new p({text:"Allocated Hours"}),new d({value:"{/projectData/allocatedHours}",type:"Number"}),new p({text:"Start Date"}),new c({value:"{/projectData/startDate}",valueFormat:"yyyy-MM-dd"}),new p({text:"End Date"}),new c({value:"{/projectData/endDate}",valueFormat:"yyyy-MM-dd"}),new p({text:"Status"}),new i({selectedKey:"{/projectData/status}",items:[new l({key:"Planning",text:"Planning"}),new l({key:"Active",text:"Active"}),new l({key:"On Hold",text:"On Hold"}),new l({key:"Completed",text:"Completed"})]})]})],beginButton:new u({text:"Save",type:"Emphasized",press:this.onSaveProject.bind(this)}),endButton:new u({text:"Cancel",press:this.onCancelProject.bind(this)})});this.getView().addDependent(this._oProjectDialog)}this._oProjectDialog.setModel(s);this._oProjectDialog.open()},onSaveProject:function(){var e=this._oProjectDialog;var a=e.getModel();var r=JSON.parse(JSON.stringify(a.getProperty("/projectData")));var s=a.getProperty("/mode");if(!r.name||!r.startDate||!r.endDate||!r.allocatedHours){t.show("Please fill in all required fields");return}r.budget=parseFloat(r.budget)||0;r.allocatedHours=parseFloat(r.allocatedHours)||0;r.usedHours=parseFloat(r.usedHours)||0;var o=new Date(r.startDate);var n=new Date(r.endDate);if(n<=o){t.show("End date must be after start date");return}if(r.usedHours<0||r.allocatedHours<0){t.show("Hours cannot be negative");return}if(r.usedHours>r.allocatedHours){t.show("Used hours cannot exceed allocated hours");return}if(s==="edit"){var i=this.getView().getModel();var l=i.getProperty("/projects");var d=l.findIndex(e=>e.projectId===r.projectId);if(d!==-1){let e=a.getProperty("/availableManagers");let s=e.find(e=>e.ID===r.managerId);let o="Unknown Manager";if(s){o=s.firstName+" "+s.lastName;r.projectOwnerName=o;r.projectOwnerId=s.ID}l[d]={...l[d],name:r.name,description:r.description,managerId:r.managerId,managerName:o,budget:r.budget,allocatedHours:r.allocatedHours,usedHours:r.usedHours,startDate:r.startDate,endDate:r.endDate,client:r.client,status:r.status};i.setProperty("/projects",l);i.refresh(true);t.show("Project updated successfully in UI")}}else if(s==="create"){t.show("Project added successfully in UI")}if(s==="create"){this._createProjectInOData(r,false)}else{this._updateProjectInOData(r,false)}e.close()},_createProjectInOData:function(e,a=true){var r=this.getOwnerComponent().getModel("adminService");var s=this;var o={projectName:e.name,description:e.description||"",projectOwner_ID:e.managerId,budget:Number(e.budget)||0,allocatedHours:Number(e.allocatedHours)||0,startDate:e.startDate,endDate:e.endDate,status:e.status,isBillable:true};console.log("Creating project with payload:",o);r.create("/Projects",o,{success:function(r){t.show("Project created successfully");var o=s._getManagersList();var n=o.find(t=>t.userId===e.managerId);var i=n?(n.firstName+" "+n.lastName).trim():"Unknown Manager";var l=s.getView().getModel();var d=l.getProperty("/projects")||[];d.push({projectId:r.projectID,name:e.name,description:e.description,managerId:e.managerId,managerName:i,budget:e.budget,allocatedHours:e.allocatedHours,usedHours:e.usedHours||0,startDate:e.startDate,endDate:e.endDate,client:e.client,status:e.status,isBillable:true,teamMembers:[]});l.setProperty("/projects",d);l.refresh(true);if(a){s._loadProjects()}},error:function(e){console.error("Error creating project:",e);t.show("Error creating project");if(a){s._loadProjects()}}})},_updateProjectInOData:function(e,a=true){var r=this.getOwnerComponent().getModel("adminService");var s=this;if(!e.projectId){t.show("Missing projectId. Cannot update.");console.warn("No projectId found in projectData:",e);return}r.read("/Projects",{success:function(o){if(!o.results||!o.results.length){t.show("No projects found in backend.");return}var n=o.results.find(t=>t.projectID===e.projectId);if(!n){t.show("Project not found in backend. Cannot update.");console.warn("No backend match for projectId:",e.projectId);return}var i=n.ID;if(!i){t.show("Backend Project ID missing. Cannot update.");console.error("Backend item has no ID field:",n);return}var l={projectName:e.name,description:e.description||"",projectOwner_ID:e.managerId,projectOwnerName:e.managerName,budget:parseFloat(e.budget)||0,allocatedHours:parseFloat(e.allocatedHours)||0,startDate:e.startDate,endDate:e.endDate,status:e.status};var d="/Projects('"+i+"')";console.log("Updating project:",i,l);r.update(d,l,{success:function(){t.show("Project updated successfully");if(a){s._loadProjects()}},error:function(e){console.error("Error updating project:",e);t.show("Error updating project");if(a){s._loadProjects()}}})},error:function(e){console.error("Error reading Projects:",e);t.show("Failed to fetch backend projects.")}})},_deleteProjectInOData:function(e){var a=this.getOwnerComponent().getModel("adminService");var r=this;a.read("/Projects",{success:function(s){if(!s.results||s.results.length===0){t.show("No projects found. Cannot delete.");return}var o=s.results.find(function(t){return t.projectID===e.projectId});if(!o){t.show("Project not found. Cannot delete.");console.warn("No backend match for projectId:",e.projectId);return}var n=o.ID;var i="/Projects('"+n+"')";console.log("Deleting project with backend ID:",n);a.remove(i,{success:function(){t.show("Project deleted successfully");r._loadProjects()},error:function(e){console.error("Error deleting project:",e);t.show("Error deleting project")}})},error:function(e){console.error("Error loading projects:",e);t.show("Error fetching project list")}})},onCancelProject:function(){if(this._oProjectDialog){this._oProjectDialog.close()}},onRefreshAnalytics:function(){this._refreshAnalyticsData();t.show("Analytics data refreshed")},_refreshAnalyticsData:function(){var e=this.getView().getModel();var t=e.getProperty("/projects")||[];var a=e.getProperty("/users")||[];var r=t.map(function(e){var t=e.usedHours||0;var a=e.allocatedHours||0;var r=a-t;var s=a>0?Math.round(t/a*100):0;return{projectId:e.projectId,projectName:e.name,allocatedHours:a,bookedHours:t,remainingHours:r,utilization:s}});var s=this._getManagersList().map(function(e){var r=a.filter(t=>t.managerId===e.userId&&t.status==="Active");var s=t.filter(t=>t.managerId===e.userId);var o=s.reduce(function(e,t){return e+(t.usedHours||0)},0);var n=s.reduce(function(e,t){return e+(t.allocatedHours||0)},0);var i=n>0?Math.round(o/n*100):0;return{managerId:e.userId,managerName:e.firstName+" "+e.lastName,teamSize:r.length,totalProjects:s.length,totalBookedHours:o,avgUtilization:i}});var o=t.map(function(e){var t=e.startDate?new Date(e.startDate):null;var a=e.endDate?new Date(e.endDate):null;var r=new Date;var s=0;if(t&&a){s=Math.ceil((a-t)/(1e3*60*60*24))}var o=0;if(a){o=Math.ceil((a-r)/(1e3*60*60*24))}var n="On Track";if(e.status==="Completed"){n="Completed"}else if(o<0){n="Delayed"}else if(o<14){n="At Risk"}return{projectId:e.projectId,projectName:e.name,startDate:t,endDate:a,durationDays:s,daysRemaining:o>0?o:0,timelineStatus:n}});var n=t.reduce(function(e,t){return e+(t.usedHours||0)},0);var i=t.reduce(function(e,t){return e+(t.allocatedHours||0)},0);var l=i-n;var d=i>0?Math.round(n/i*100):0;e.setProperty("/overallProgress",{totalBookedHours:n,totalAllocatedHours:i,totalRemainingHours:l,averageUtilization:d});e.setProperty("/projectHours",r);e.setProperty("/managerTeams",s);e.setProperty("/projectDurations",o);e.refresh(true);this._loadOverallProgress()},formatCurrency:function(e){if(e===null||e===undefined||isNaN(e)){return"$0.00"}var t=parseFloat(e);return"$"+t.toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")},onRefreshUsers:function(){this._loadEmployees();t.show("Users data refreshed")},onRefreshProjects:function(){this._loadProjects();t.show("Projects data refreshed")},onRefreshPage:function(){window.location.reload()}})});
//# sourceMappingURL=Admin.controller.js.map