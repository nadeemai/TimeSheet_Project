sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/BusyIndicator","sap/m/MessageToast","sap/ui/core/Fragment","sap/m/MenuItem","sap/m/Menu","sap/m/Dialog","sap/m/MessageBox"],(e,t,a,r,s,o,n,i,d)=>{"use strict";return e.extend("employee.controller.Employee",{onInit:function(){var e=this.getView();var t=new sap.ui.model.json.JSONModel({selectedDate:this._formatDateForModel(new Date),dailySummary:[],totalWeekHours:"0.00",currentWeek:"",isSubmitted:false,timeEntriesCount:0,commentsCount:0,timeEntries:[],hoursWorked:0,isTaskDisabled:false,newEntry:{},projects:[],nonProjectTypeName:"",nonProjects:[],workTypes:[],workType:"",dailyTotals:{monday:0,tuesday:0,wednesday:0,thursday:0,friday:0,saturday:0,sunday:0},weekDates:this._generateWeekDates(new Date)});e.setModel(t,"timeEntryModel");this._loadTimeEntriesFromBackend();var a=this.getOwnerComponent().getModel("timesheetServiceV2");a.read("/MyProjects",{success:function(t){var a=t.d?t.d.results:t.results;var r=a.map(function(e){return{projectName:e.projectName,status:e.status,managerName:e.projectOwnerName}});var s=new sap.ui.model.json.JSONModel;s.setData({assignedProjects:r});e.setModel(s,"assignedProjects")}.bind(this),error:function(e){console.error("Failed to load projects",e)}});this._loadReportData(a,e)},_getCurrentWeekMonday:function(){let e=new Date;let t=e.getDay();let a=t===0?-6:1-t;let r=new Date(e);r.setDate(e.getDate()+a);r.setHours(0,0,0,0);return r},onRefreshAnalytics:function(){console.log("Refreshing Reports‚Ä¶");var e=this.getOwnerComponent().getModel("timesheetServiceV2");var t=this.getView();sap.ui.core.BusyIndicator.show();this._loadReportData(e,t);setTimeout(()=>{sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Report data updated ‚ú®")},1e3)},onTabSelect:function(e){var t=e.getParameter("key");if(t==="reportsTab"){console.log("Reports tab activated ‚Üí refreshing data");var a=this.getOwnerComponent().getModel("timesheetServiceV2");var r=this.getView();sap.ui.core.BusyIndicator.show();this._loadReportData(a,r);setTimeout(()=>{sap.ui.core.BusyIndicator.hide()},800)}},_loadReportData:function(e,t){e.read("/BookedHoursOverview",{success:function(e){var a=e.d?e.d.results:e.results;var r=new sap.ui.model.json.JSONModel;r.setData({employeeProjectHours:a});t.setModel(r,"bookedHoursModel")},error:function(e){console.error("Failed to load Booked Hours Overview",e)}});e.read("/ProjectEngagementDuration",{success:function(e){var a=e.d?e.d.results:e.results;var r=new sap.ui.model.json.JSONModel;r.setData({employeeProjectDurations:a});t.setModel(r,"durationModel")},error:function(e){console.error("Failed to load Project Engagement Duration",e)}})},_generateWeekDates:function(e){var t=new Date(e);t.setDate(e.getDate()-e.getDay()+1);var a={};var r=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];r.forEach((e,r)=>{var s=new Date(t);s.setDate(t.getDate()+r);a[e]=s;a[e+"Formatted"]=this._formatDateForDisplay(s)});return a},_checkRowDeleteEligibility:function(e){return(parseFloat(e.mondayHours)||0)===0&&(parseFloat(e.tuesdayHours)||0)===0&&(parseFloat(e.wednesdayHours)||0)===0&&(parseFloat(e.thursdayHours)||0)===0&&(parseFloat(e.fridayHours)||0)===0&&(parseFloat(e.saturdayHours)||0)===0&&(parseFloat(e.sundayHours)||0)===0},_loadTimeEntriesFromBackend:function(){let e=this.getOwnerComponent().getModel("timesheetServiceV2");let t=this.getView();let r=t.getModel("timeEntryModel");if(!e){console.error("No OData model found");return}a.show(0);let s=r.getProperty("/selectedDate");if(!s){let e=this._getCurrentWeekMonday();s=e.toISOString().split("T")[0]}this._fetchWeekBoundaries(s).then(r=>{let s=r.getWeekBoundaries.weekStart;let o=r.getWeekBoundaries.weekEnd;this._updateWeekDates(new Date(s));e.read("/MyTimesheets",{success:function(e){a.hide();let r=e.results||[];let n=r.reduce((e,t)=>{let a=parseFloat(t.totalWeekHours)||0;return e+a},0);let i=this.getView().getModel("timeEntryModel");i.setProperty("/totalWeekHours",n);let d=i.getProperty("/weekDates");let l=e=>new Date(e);let u=r.filter(e=>{let t=e.weekStartDate?l(e.weekStartDate):null;let a=e.weekEndDate?l(e.weekEndDate):null;return t?.getTime()===s.getTime()&&a?.getTime()===o.getTime()});let y=u.map(e=>{let t=e.projectName&&e.projectName.trim()!==""?e.projectName:e.nonProjectTypeName||"";return{id:e.ID,totalWeekHours:e.totalWeekHours,projectId:e.project_ID,nonProjectId:e.nonProjectType_ID,projectName:t,originalProjectName:e.projectName,originalNonProjectName:e.nonProjectTypeName,workType:e.task,status:e.status,weekStart:e.weekStartDate,weekEnd:e.weekEndDate,mondayHours:e.mondayHours,tuesdayHours:e.tuesdayHours,wednesdayHours:e.wednesdayHours,thursdayHours:e.thursdayHours,fridayHours:e.fridayHours,saturdayHours:e.saturdayHours,sundayHours:e.sundayHours,mondayTaskDetails:e.mondayTaskDetails,tuesdayTaskDetails:e.tuesdayTaskDetails,wednesdayTaskDetails:e.wednesdayTaskDetails,thursdayTaskDetails:e.thursdayTaskDetails,fridayTaskDetails:e.fridayTaskDetails,saturdayTaskDetails:e.saturdayTaskDetails,sundayTaskDetails:e.sundayTaskDetails,dates:d}});y.forEach(e=>{e.canDelete=this._checkRowDeleteEligibility(e)});i.setProperty("/timeEntries",y);let c=this._calculateDailyTotals(y);i.setProperty("/dailyTotals",c);let p=Object.values(c).reduce((e,t)=>e+t,0);i.setProperty("/totalWeekHours",p.toFixed(2));let m=t.byId("timesheetTable");m?.getBinding("items")?.refresh(true)}.bind(this),error:function(e){a.hide();console.error(e);i.show("Failed to load timesheet")}})}).catch(e=>{a.hide();console.error(e);i.show("Week boundary fetch failed")})},_calculateDailyTotals:function(e){let t={monday:0,tuesday:0,wednesday:0,thursday:0,friday:0,saturday:0,sunday:0};e.forEach(e=>{t.monday+=parseFloat(e.mondayHours||0);t.tuesday+=parseFloat(e.tuesdayHours||0);t.wednesday+=parseFloat(e.wednesdayHours||0);t.thursday+=parseFloat(e.thursdayHours||0);t.friday+=parseFloat(e.fridayHours||0);t.saturday+=parseFloat(e.saturdayHours||0);t.sunday+=parseFloat(e.sundayHours||0)});return t},_formatDateForModel:function(e){return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)},_getCurrentWeekDates:function(){let e=new Date;let t=e.getDay();let a=t===0?-6:1-t;let r=new Date(e);r.setDate(e.getDate()+a);let s=e=>e.toISOString().split("T")[0];let o=s(r);let n=s(new Date(r.getTime()+6*864e5));return{weekStart:o,weekEnd:n,monday:o,tuesday:s(new Date(r.getTime()+1*864e5)),wednesday:s(new Date(r.getTime()+2*864e5)),thursday:s(new Date(r.getTime()+3*864e5)),friday:s(new Date(r.getTime()+4*864e5)),saturday:s(new Date(r.getTime()+5*864e5)),sunday:n}},_formatDateForDisplay:function(e){if(!e)return"";let t=typeof e==="string"?new Date(e):e;let a={month:"short",day:"numeric"};return t.toLocaleDateString("en-US",a)},onCancelNewEntry:function(){this._oAddEntryDialog.close()},_isFutureDate:function(e,t,a){let r=new Date(e);return r>new Date(a)},onEntryDatePickerChange:function(e){var t=this;var a=this.getView().getModel("timeEntryModel");var r=this.getOwnerComponent().getModel("timesheetServiceV2");var s=e.getParameter("value");if(!s)return;var o=this._dayPropertyFromDate(s);var n=a.getProperty("/newEntry")||{};n.selectedDate=s;n.day=o;a.setProperty("/newEntry",n);var i=new Promise(e=>{r.read("/MyProjects",{success:t=>{let r=(t.results||[]).map(e=>({id:e.ID,name:e.projectName,isNonProject:false}));a.setProperty("/projects",r);e()},error:()=>{a.setProperty("/projects",[]);e()}})});var d=new Promise(e=>{r.read("/AvailableNonProjectTypes",{success:t=>{let r=(t.results||[]).map(e=>({id:e.ID,name:e.typeName,isNonProject:true,isLeave:e.typeName.toLowerCase().includes("leave")||e.typeName==="Sick Leave"}));a.setProperty("/nonProjects",r);e()},error:()=>{a.setProperty("/nonProjects",[]);e()}})});var l=new Promise(e=>{r.read("/AvailableTaskTypes",{success:t=>{let r=(t.results||[]).map(e=>({type:e.code,name:e.name}));a.setProperty("/workTypes",r);e()},error:()=>{a.setProperty("/workTypes",[]);e()}})});Promise.all([i,d,l]).then(()=>{let e=a.getProperty("/projects")||[];let r=a.getProperty("/nonProjects")||[];let o=a.getProperty("/workTypes")||[];let i=n.day;let d=t._getCurrentWeekDates();let l=t._isFutureDate(s,d.weekStart,d.weekEnd);let u=i==="saturday"||i==="sunday";let y=[];let c=r.filter(e=>!e.isLeave);if(l){if(u){y=c.map(e=>({id:e.id,name:e.name,isNonProject:true}))}else{y=r.map(e=>({id:e.id,name:e.name,isNonProject:true}))}a.setProperty("/isTaskDisabled",true);a.setProperty("/tasksToShow",[])}else if(u){y=[...e.map(e=>({id:e.id,name:e.name,isNonProject:false})),...c.map(e=>({id:e.id,name:e.name,isNonProject:true}))];a.setProperty("/isTaskDisabled",true);a.setProperty("/tasksToShow",[])}else{y=[...e,...r];a.setProperty("/isTaskDisabled",true);a.setProperty("/tasksToShow",[])}a.setProperty("/projectsToShow",y);let p=y.some(e=>e.id===(n.projectId||n.nonProjectTypeID));if(!p){n.projectId="";n.projectName="";n.nonProjectTypeID="";n.nonProjectTypeName="";n.workType="";a.setProperty("/newEntry",n);a.setProperty("/isTaskDisabled",true);a.setProperty("/tasksToShow",[])}})},_fetchWeekBoundaries:function(e){var t=this.getOwnerComponent().getModel("timesheetServiceV2");return new Promise((a,r)=>{t.callFunction("/getWeekBoundaries",{method:"GET",urlParameters:{workDate:e},success:function(e){a(e)},error:r})})},onAddEntry:function(){var e=this;var t=this.getView().getModel("timeEntryModel");var a=this.getOwnerComponent().getModel("timesheetServiceV2");var r=new Date;var s=this._currentWeekStartDate||new Date;var o=this._formatDateForModel(s);t.setProperty("/newEntry",{selectedDate:o,projectId:"",projectName:"",nonProjectTypeID:"",nonProjectTypeName:"",workType:"",hours:"",taskDetails:"",dailyComments:{}});var n=new Promise(function(e){a.read("/MyProjects",{success:function(a){var r=a.results.map(e=>({projectId:e.ID,projectName:e.projectName}));t.setProperty("/projects",r);e()},error:function(){t.setProperty("/projects",[]);e()}})});var i=new Promise(function(e){a.read("/AvailableNonProjectTypes",{success:function(a){var r=a.results.map(e=>({nonProjectTypeID:e.ID,nonProjectTypeName:e.typeName}));t.setProperty("/nonProjects",r);e()},error:function(){t.setProperty("/nonProjects",[]);e()}})});var d=new Promise(function(e){a.read("/AvailableTaskTypes",{success:function(a){var r=a.results.map(e=>({type:e.code,name:e.name}));t.setProperty("/workTypes",r);e()},error:function(){t.setProperty("/workTypes",[]);e()}})});Promise.all([n,i,d]).then(function(){var a=e._currentWeekStartDate||new Date;var r=new Date;r.setHours(0,0,0,0);a.setHours(0,0,0,0);var s=a>r;var o=t.getProperty("/projects")||[];var n=t.getProperty("/nonProjects")||[];if(s){var i=n.map(e=>({id:e.nonProjectTypeID,name:e.nonProjectTypeName,isNonProject:true}));t.setProperty("/projectsToShow",i);t.setProperty("/tasksToShow",[]);t.setProperty("/isTaskDisabled",true)}else{var i=[...o.map(e=>({id:e.projectId,name:e.projectName,isNonProject:false})),...n.map(e=>({id:e.nonProjectTypeID,name:e.nonProjectTypeName,isNonProject:true}))];t.setProperty("/projectsToShow",i);t.setProperty("/tasksToShow",t.getProperty("/workTypes")||[]);t.setProperty("/isTaskDisabled",true)}if(!e._oAddEntryDialog){e._oAddEntryDialog=sap.ui.xmlfragment(e.getView().getId(),"employee.Fragments.AddTimeEntry",e);e.getView().addDependent(e._oAddEntryDialog)}e._oAddEntryDialog.getContent().forEach(function(e){if(e.setValue)e.setValue("");if(e.setSelectedKey)e.setSelectedKey("");if(e.setSelectedIndex)e.setSelectedIndex(-1)});e._oAddEntryDialog.open()})},onProjectChange:function(e){var t=this.getView().getModel("timeEntryModel");var a=e.getSource().getSelectedItem();if(!a)return;var r=a.getKey();var s=a.getText();var o=t.getProperty("/projectsToShow")||[];var n=o.find(e=>e.id===r);if(!n)return;var i=t.getProperty("/newEntry")||{};if(n.isNonProject){t.setProperty("/newEntry/nonProjectTypeID",r);t.setProperty("/newEntry/nonProjectTypeName",s);t.setProperty("/newEntry/projectId","");t.setProperty("/newEntry/projectName","");t.setProperty("/newEntry/workType","");t.setProperty("/tasksToShow",[]);t.setProperty("/isTaskDisabled",true)}else{t.setProperty("/newEntry/projectId",r);t.setProperty("/newEntry/projectName",s);t.setProperty("/newEntry/nonProjectTypeID","");t.setProperty("/newEntry/nonProjectTypeName","");t.setProperty("/newEntry/workType","");t.setProperty("/tasksToShow",t.getProperty("/workTypes")||[]);t.setProperty("/isTaskDisabled",false)}t.setProperty("/newEntry",i)},onSaveNewEntry:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel("timeEntryModel");var t=e.getProperty("/newEntry")||{};var a=this;if(!this._validateMandatoryFields(t)){sap.ui.core.BusyIndicator.hide();return false}var r=parseFloat(t.hours)||0;if(r<=0||r>15){sap.m.MessageBox.error("Hours must be between 0 and 15");return false}var s=t.selectedDate;var o=this._dayPropertyFromDate(s);var n=o+"Hours";var i=o+"TaskDetails";const d=e.getProperty("/timeEntries")||[];let l=false;d.forEach(e=>{if(e.workType===t.workType&&(e.projectName===t.projectName||e.nonProjectTypeName===t.nonProjectTypeName)){l=true}});if(l){sap.m.MessageBox.warning("Bruh‚Ä¶ This entry already exists üëÄ");if(this._oAddEntryDialog){this._oAddEntryDialog.close();sap.ui.core.BusyIndicator.hide()}return}var u={project_ID:null,nonProjectType_ID:null,projectName:t.projectName||"",nonProjectTypeName:t.nonProjectTypeName,nonProjectTypeID:t.nonProjectTypeID,task:t.workType||"",status:"Draft",isBillable:t.isBillable,mondayHours:"0.00",mondayTaskDetails:"",mondayDate:null,tuesdayHours:"0.00",tuesdayTaskDetails:"",tuesdayDate:null,wednesdayHours:"0.00",wednesdayTaskDetails:"",wednesdayDate:null,thursdayHours:"0.00",thursdayTaskDetails:"",thursdayDate:null,fridayHours:"0.00",fridayTaskDetails:"",fridayDate:null,saturdayHours:"0.00",saturdayTaskDetails:"",saturdayDate:null,sundayHours:"0.00",sundayTaskDetails:"",sundayDate:null};u[n]=r;u[i]=t.taskDetails||"";if(t.isBillable){u.nonProjectType_ID=t.projectId;u.project_ID=null}else{u.project_ID=t.projectId;u.nonProjectType_ID=null}this._fetchWeekBoundaries(s).then(e=>a._persistToBackend(u,s,e)).then(()=>{a._loadTimeEntriesFromBackend();sap.m.MessageToast.show("Timesheet saved!");sap.ui.core.BusyIndicator.hide()}).catch(e=>{console.error("‚ùå Error while creating entry: ",e)});return true},_resetNewEntryFields:function(){let e=this.getView().getModel("timeEntryModel");e.setProperty("/newEntry",{projectId:"",projectName:"",nonProjectTypeID:"",nonProjectTypeName:"",workType:"",isBillable:false,taskDetails:"",hours:"",selectedDate:e.getProperty("/newEntry/selectedDate")})},onSaveAndNewEntry:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel("timeEntryModel");var t=e.getProperty("/newEntry")||{};var a=this;if(!this._validateMandatoryFields(t)){sap.ui.core.BusyIndicator.hide();return false}var r=parseFloat(t.hours)||0;if(r<=0||r>15){sap.m.MessageBox.error("Hours must be between 0 and 15");sap.ui.core.BusyIndicator.hide();return false}var s=t.selectedDate;var o=this._dayPropertyFromDate(s);var n=o+"Hours";var i=o+"TaskDetails";const d=e.getProperty("/timeEntries")||[];let l=false;d.forEach(e=>{if(e.workType===t.workType&&(e.projectName===t.projectName||e.nonProjectTypeName===t.nonProjectTypeName)){l=true}});if(l){sap.m.MessageBox.warning("Bruh‚Ä¶ This entry already exists üëÄ");if(this._oAddEntryDialog){this._oAddEntryDialog.close();sap.ui.core.BusyIndicator.hide()}return}var u={project_ID:null,nonProjectType_ID:null,projectName:t.projectName||"",nonProjectTypeName:t.nonProjectTypeName,nonProjectTypeID:t.nonProjectTypeID,task:t.workType||"",status:"Draft",isBillable:t.isBillable,mondayHours:"0.00",mondayTaskDetails:"",mondayDate:null,tuesdayHours:"0.00",tuesdayTaskDetails:"",tuesdayDate:null,wednesdayHours:"0.00",wednesdayTaskDetails:"",wednesdayDate:null,thursdayHours:"0.00",thursdayTaskDetails:"",thursdayDate:null,fridayHours:"0.00",fridayTaskDetails:"",fridayDate:null,saturdayHours:"0.00",saturdayTaskDetails:"",saturdayDate:null,sundayHours:"0.00",sundayTaskDetails:"",sundayDate:null};u[n]=r;u[i]=t.taskDetails||"";if(t.isBillable){u.nonProjectType_ID=t.projectId}else{u.project_ID=t.projectId}this._fetchWeekBoundaries(s).then(e=>a._persistToBackendNew(u,s,e)).then(()=>{a._loadTimeEntriesFromBackend();a._resetNewEntryFields();sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Saved! Add another entry.")}).catch(e=>{console.error("‚ùå Error while saving entry: ",e);if(this._oAddEntryDialog){this._oAddEntryDialog.close();sap.ui.core.BusyIndicator.hide()}});return true},_persistToBackendNew:async function(e,t,a){var r=this.getOwnerComponent().getModel("timesheetServiceV2");let s=this;var o=this._dayPropertyFromDate(t);if(!o)return Promise.reject("Invalid day property");var n=this.getView().getModel("timeEntryModel").getProperty("/newEntry")||{};var i=Number(e[o+"Hours"])||0;var d=n.taskDetails||"";e[o+"TaskDetails"]=d;let l=await this._getWeekStartEndOData(t);console.log("Week boundary:",l);let u=l.weekStart;let y=l.weekEnd;let c={monday:"mondayDate",tuesday:"tuesdayDate",wednesday:"wednesdayDate",thursday:"thursdayDate",friday:"fridayDate",saturday:"saturdayDate",sunday:"sundayDate"};let p=c[o];function m(e){return`/Date(${new Date(e).getTime()})/`}var D=this.getOwnerComponent().getModel("currentUser").getData();let g=D.id;var h={employee_ID:g,weekStartDate:u,weekEndDate:y,project_ID:e.project_ID||null,projectName:e.projectName,nonProjectType_ID:e.nonProjectTypeID,nonProjectTypeName:e.nonProjectTypeName,task:e.task,status:"Draft",isBillable:true,mondayHours:e.mondayHours,mondayTaskDetails:e.mondayTaskDetails||"",mondayDate:null,tuesdayHours:e.tuesdayHours,tuesdayTaskDetails:e.tuesdayTaskDetails||"",tuesdayDate:null,wednesdayHours:e.wednesdayHours,wednesdayTaskDetails:e.wednesdayTaskDetails||"",wednesdayDate:null,thursdayHours:e.thursdayHours,thursdayTaskDetails:e.thursdayTaskDetails||"",thursdayDate:null,fridayHours:e.fridayHours,fridayTaskDetails:e.fridayTaskDetails||"",fridayDate:null,saturdayHours:e.saturdayHours,saturdayTaskDetails:e.saturdayTaskDetails||"",saturdayDate:null,sundayHours:e.sundayHours,sundayTaskDetails:e.sundayTaskDetails||"",sundayDate:null};h[p]=m(t);var w={[`${o}Hours`]:i.toFixed(2),[`${o}TaskDetails`]:d};return new Promise((a,n)=>{r.read("/MyTimesheets",{filters:[new sap.ui.model.Filter({path:"employee_ID",operator:"EQ",value1:g})],success:function(d){let l=d?.results||[];function u(e){if(!e)return null;try{return new Date(e).toISOString().split("T")[0]}catch(e){return null}}function y(e){if(e.includes("-"))return e;let t=e.split("/");if(t.length!==3)return null;let[a,r,s]=t;let o=s.length===2?"20"+s:s;return`${o}-${a.padStart(2,"0")}-${r.padStart(2,"0")}`}let c={monday:"mondayDate",tuesday:"tuesdayDate",wednesday:"wednesdayDate",thursday:"thursdayDate",friday:"fridayDate",saturday:"saturdayDate",sunday:"sundayDate"};let p=c[o];let m=y(t);let D=l.filter(e=>{let t=u(e[p]);return t&&m&&t===m});let g=D.reduce((e,t)=>e+(Number(t[o+"Hours"])||0),0);let f=D.find(e=>e.task===h.task);if(f){g-=Number(f[o+"Hours"])||0}let k=r.getProperty("/dailyTotals")||{};let T=Number(k[o]||0);let P=Number(i)||0;let v=g+Number(i);if(v>15){sap.m.MessageBox.error(`Woah steady there You can only log 15 hours max on ${t}.`);if(s._oAddEntryDialog){s._oAddEntryDialog.close();sap.ui.core.BusyIndicator.hide()}return}if(f){r.update("/MyTimesheets(guid'"+f.ID+"')",w,{success:function(e){if(s._oAddEntryDialog){s._oAddEntryDialog.close()}sap.m.MessageToast.show("Timesheet updated successfully!");a(e)},error:n})}else{r.create("/MyTimesheets",h,{success:function(t){let n=s.getView().getModel("timeEntryModel");n.setProperty("/newEntry",{project_ID:null,projectName:"",nonProjectTypeID:null,nonProjectTypeName:"",task:"",taskDetails:"",mondayHours:null,tuesdayHours:null,wednesdayHours:null,thursdayHours:null,fridayHours:null,saturdayHours:null,sundayHours:null});r.setProperty("/projectsToShow",[]);r.setProperty("/tasksToShow",[]);e[o+"Hours"]=null;e[o+"TaskDetails"]="";sap.m.MessageToast.show("Timesheet saved! Form reset successfully.");a(t)},error:function(e){sap.m.MessageBox.error("Failed to save timesheet. Check mandatory fields.");sap.ui.core.BusyIndicator.hide();n(e)}})}},error:n})})},_getWeekStartEndOData:async function(e){if(!e){console.warn("No date provided to _getWeekStartEndOData");return{weekStart:null,weekEnd:null}}function t(e){if(/^\d{2}\/\d{2}\/\d{2}$/.test(e)){let[t,a,r]=e.split("/");return`20${r}-${t}-${a}`}return e}let a=t(e);try{let t=this.getOwnerComponent().getModel("timesheetServiceV2");let r=await new Promise((e,r)=>{t.callFunction("/getWeekBoundaries",{method:"GET",urlParameters:{workDate:a},success:e,error:r})});if(!r?.weekStart||!r?.weekEnd){console.warn("Backend did not return a valid week boundary for:",e);return{weekStart:null,weekEnd:null}}return{weekStart:r.weekStart,weekEnd:r.weekEnd}}catch(e){console.error("Failed fetching week boundaries from backend:",e);return{weekStart:null,weekEnd:null}}},onDeleteRows:function(e){let t=e.getSource().getBindingContext("timeEntryModel").getObject();this._deleteEntryIfZero(t)},_deleteEntryIfZero:function(e){sap.ui.core.BusyIndicator.show(0);const t=["mondayHours","tuesdayHours","wednesdayHours","thursdayHours","fridayHours","saturdayHours","sundayHours"];let a=t.every(t=>Number(e[t]||0)===0);if(!a){sap.m.MessageBox.information("Cannot delete ‚Äî this row has hours.");sap.ui.core.BusyIndicator.hide();return}const r=this.getOwnerComponent().getModel("timesheetServiceV2");const s="/MyTimesheets('"+e.id+"')";const o=this;r.remove(s,{success:function(){let t=o.getView().getModel("timeEntryModel").getProperty("/timeEntries")||[];let a=t.filter(t=>t.id!==e.id);o.getView().getModel("timeEntryModel").setProperty("/timeEntries",a);sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deleted successfully.")},error:function(e){console.error("Delete failed",e);sap.ui.core.BusyIndicator.hide()}})},_persistToBackend:async function(e,t,a){var r=this.getOwnerComponent().getModel("timesheetServiceV2");let s=this;var o=this._dayPropertyFromDate(t);if(!o)return Promise.reject("Invalid day property");var n=this.getView().getModel("timeEntryModel").getProperty("/newEntry")||{};var i=Number(e[o+"Hours"])||0;var d=n.taskDetails||"";e[o+"TaskDetails"]=d;let l=await this._getWeekStartEndOData(t);let u=l.weekStart;let y=l.weekEnd;let c={monday:"mondayDate",tuesday:"tuesdayDate",wednesday:"wednesdayDate",thursday:"thursdayDate",friday:"fridayDate",saturday:"saturdayDate",sunday:"sundayDate"};let p=c[o];function m(e){return`/Date(${new Date(e).getTime()})/`}var D=this.getOwnerComponent().getModel("currentUser").getData();let g=D.id;var h={employee_ID:g,weekStartDate:u,weekEndDate:y,project_ID:e.project_ID||null,projectName:e.projectName,nonProjectType_ID:e.nonProjectTypeID,nonProjectTypeName:e.nonProjectTypeName,task:e.task,status:"Draft",isBillable:true,mondayHours:e.mondayHours,mondayTaskDetails:e.mondayTaskDetails||"",mondayDate:null,tuesdayHours:e.tuesdayHours,tuesdayTaskDetails:e.tuesdayTaskDetails||"",tuesdayDate:null,wednesdayHours:e.wednesdayHours,wednesdayTaskDetails:e.wednesdayTaskDetails||"",wednesdayDate:null,thursdayHours:e.thursdayHours,thursdayTaskDetails:e.thursdayTaskDetails||"",thursdayDate:null,fridayHours:e.fridayHours,fridayTaskDetails:e.fridayTaskDetails||"",fridayDate:null,saturdayHours:e.saturdayHours,saturdayTaskDetails:e.saturdayTaskDetails||"",saturdayDate:null,sundayHours:e.sundayHours,sundayTaskDetails:e.sundayTaskDetails||"",sundayDate:null};h[p]=m(t);return new Promise((e,a)=>{r.read("/MyTimesheets",{filters:[new sap.ui.model.Filter({path:"employee_ID",operator:"EQ",value1:g})],success:function(n){let d=n?.results||[];function l(e){if(!e)return null;try{return new Date(e).toISOString().split("T")[0]}catch(e){return null}}function u(e){if(e.includes("-"))return e;let t=e.split("/");if(t.length!==3)return null;let[a,r,s]=t;let o=s.length===2?"20"+s:s;return`${o}-${a.padStart(2,"0")}-${r.padStart(2,"0")}`}let y={monday:"mondayDate",tuesday:"tuesdayDate",wednesday:"wednesdayDate",thursday:"thursdayDate",friday:"fridayDate",saturday:"saturdayDate",sunday:"sundayDate"};let c=y[o];let p=u(t);let m=d.filter(e=>{let t=l(e[c]);return t&&p&&t===p});let D=m.reduce((e,t)=>e+(Number(t[o+"Hours"])||0),0);let g=D+Number(i);if(g>15){sap.m.MessageBox.error(`You can only log 15 hours max on ${t}.`);if(s._oAddEntryDialog){s._oAddEntryDialog.close();sap.ui.core.BusyIndicator.hide()}return}r.create("/MyTimesheets",h,{success:function(t){if(s._oAddEntryDialog){s._oAddEntryDialog.close()}r.setProperty("/projectsToShow",[]);r.setProperty("/tasksToShow",[]);sap.m.MessageToast.show("Timesheet saved!");e(t)},error:function(e){sap.m.MessageBox.error("Failed to save timesheet. Check mandatory fields.");sap.ui.core.BusyIndicator.hide();a(e)}})},error:a})})},validateDailyHours:async function(e,t,a,r=null){let s=await SELECT.from("MyTimesheets").where({employee_ID:e,workDate:t});let o=0;for(let e of s){o+=Number(e.hours||0)}if(r){let e=s.find(e=>e.ID===r);if(e){o-=Number(e.hours||0)}}return o+a<=15},_getWeekStartEndOData:async function(e){if(!e){console.warn("No date provided to _getWeekStartEndOData");return{weekStart:null,weekEnd:null}}let t=this._parseToDate(e);if(!t){return{weekStart:null,weekEnd:null}}let a=new Date;let r=this._getWeekRange(t);let s=this._getWeekRange(a);let o=r.start===s.start&&r.end===s.end;if(o){console.warn("Selected date is in CURRENT week ‚Üí Using Backend Boundaries");return await this._callBackendWeekBoundaryAPI(t)}console.warn("Selected date is NOT current week ‚Üí Using Local Calculation");return this._calculateWeekBoundaryFromDate(t)},_parseToDate:function(e){try{let t;if(e.includes("-")){let a=e.split("-");if(a.length!==3)return null;t=new Date(a[0],a[1]-1,a[2])}else if(e.includes("/")){let a=e.split("/");if(a.length!==3)return null;let r=Number(a[0]),s=Number(a[1]),o=Number(a[2]);if(r>12){t=new Date(o<100?2e3+o:o,s-1,r)}else{t=new Date(o<100?2e3+o:o,r-1,s)}}else return null;return isNaN(t.getTime())?null:t}catch{return null}},_calculateWeekBoundaryFromDate:function(e){let t=e.getDay();let a=t===0?-6:1-t;let r=new Date(e);r.setHours(5,30,0,0);r.setDate(e.getDate()+a);let s=new Date(r);s.setDate(r.getDate()+6);return{weekStart:`/Date(${r.getTime()})/`,weekEnd:`/Date(${s.getTime()})/`}},_getWeekRange:function(e){let t=new Date(e);let a=t.getDay()===0?-6:1-t.getDay();let r=new Date(t);r.setDate(t.getDate()+a);let s=new Date(r);s.setDate(r.getDate()+6);let o=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;return{start:o(r),end:o(s)}},_callBackendWeekBoundaryAPI:function(e){return new Promise((t,a)=>{try{if(!(e instanceof Date)||isNaN(e.getTime())){console.warn("Invalid date supplied to backend week boundary call.");return t({weekStart:null,weekEnd:null})}let a=e.getFullYear();let r=String(e.getMonth()+1).padStart(2,"0");let s=String(e.getDate()).padStart(2,"0");let o=`${a}-${r}-${s}`;let n=this.getOwnerComponent().getModel("timesheetServiceV2");let i=`/getWeekBoundaries?date='${o}'`;n.read(i,{success:e=>{if(e&&e.getWeekBoundaries.weekStart&&e.getWeekBoundaries.weekEnd){t({weekStart:e.getWeekBoundaries.weekStart,weekEnd:e.getWeekBoundaries.weekEnd})}else{console.warn("Backend returned no week boundary values");t({weekStart:null,weekEnd:null})}},error:e=>{console.error("Backend week boundary error:",e);t({weekStart:null,weekEnd:null})}})}catch(e){console.error("Unhandled error calling week boundary API:",e);t({weekStart:null,weekEnd:null})}})},_formatDateForOData:function(e){if(!e)return null;let[t,a,r]=e.split("/");return`datetime('${r}-${a}-${t}T00:00:00')`},_dayPropertyFromDate:function(e){if(!e)return undefined;let t,a,r;e=e.trim();if(/^\d{4}-\d{2}-\d{2}$/.test(e)){[r,a,t]=e.split("-")}else if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(e)){let s=e.split("/");let o=parseInt(s[0],10);let n=parseInt(s[1],10);if(o<=12&&n>12){s=[s[1],s[0],s[2]]}t=s[0].padStart(2,"0");a=s[1].padStart(2,"0");r=s[2].length===2?"20"+s[2]:s[2]}else{return undefined}let s=new Date(Number(r),Number(a)-1,Number(t));if(isNaN(s.getTime())||s.getFullYear()!==Number(r)||s.getMonth()+1!==Number(a)||s.getDate()!==Number(t)){return undefined}let o=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];return o[s.getDay()]},_saveEditedDayHoursAuto:function(e,t,a,r){let s=this.getView().getModel("timeEntryModel");let o=this.getOwnerComponent().getModel("timesheetServiceV2");let n=s.getProperty("/timeEntries")||[];let i=n.findIndex(t=>t.id===e.id);if(i===-1){sap.m.MessageBox.error("Entry not found");return}function d(e){if(!e)return null;if(typeof e==="string"&&e.startsWith("/Date(")){let t=parseInt(e.match(/\/Date\((\d+)\)\//)[1],10);let a=new Date(t);return a.toISOString().split("T")[0]}if(e instanceof Date){return e.toISOString().split("T")[0]}return null}let l={monday:"monday",tuesday:"tuesday",wednesday:"wednesday",thursday:"thursday",friday:"friday",saturday:"saturday",sunday:"sunday"};let u=e.dates?e.dates[l[t]]:null;let y=u?Number(e[t+"Hours"]||0):0;let c=Number(a)||0;let p=n.reduce((e,a,r)=>{if(r===i){return e+c}return e+Number(a[t]||0)},0);if(p>=16){sap.m.MessageBox.error(`Total hours for ${t.charAt(0).toUpperCase()+t.slice(1)} cannot exceed 15.`);return}let m=s.getProperty("/dailyTotals")||{};let D=Number(m[t]||0);let g=D-y+c;if(c>=15){sap.m.MessageBox.error(`Total hours for ${t.charAt(0).toUpperCase()+t.slice(1)} cannot exceed 15.`);return}if(g>=15){sap.m.MessageBox.error(`Total hours for ${t.charAt(0).toUpperCase()+t.slice(1)} cannot exceed 15.`);return}if(c===0){if(n[i][t+"TaskDetails"]){sap.m.MessageBox.warning("Task details will be removed when hours are set to 0.")}r=""}let h=n[i][t+"TaskDetails"];let w=c-y;n[i][t]=c;n[i][t+"TaskDetails"]=r||"";s.setProperty("/timeEntries",n);let f={[`${t}Hours`]:c,[`${t}TaskDetails`]:r||""};sap.ui.core.BusyIndicator.show(0);let k=e.id?`/MyTimesheets(guid'${e.id}')`:"/MyTimesheets";let T=()=>{sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(`${t.charAt(0).toUpperCase()+t.slice(1)} saved successfully`);let e=s.getProperty("/dailyTotals")||{};e[t]=n.reduce((e,a)=>e+Number(a[t]||0),0);s.setProperty("/dailyTotals",e);let a=Object.values(e).reduce((e,t)=>e+t,0);s.setProperty("/totalWeekHours",a.toFixed(2));this._loadTimeEntriesFromBackend()};let P=()=>{sap.ui.core.BusyIndicator.hide();n[i][t]=y;n[i][t+"TaskDetails"]=h;s.setProperty("/timeEntries",n);let e=s.getProperty("/dailyTotals")||{};e[t]=n.reduce((e,a)=>e+Number(a[t]||0),0);s.setProperty("/dailyTotals",e);s.setProperty("/totalWeekHours",Object.values(e).reduce((e,t)=>e+t,0).toFixed(2));sap.m.MessageBox.error("Failed to save entry")};if(e.id){o.update(k,f,{method:"PATCH",success:T,error:P})}else{o.create(k,f,{success:T,error:P})}},_capitalize:function(e){if(!e||typeof e!=="string")return"";return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},onEditDailyHours:function(e){var t=e.getSource();var a=t.data("day");var r=t.getBindingContext("timeEntryModel");if(!r){sap.m.MessageToast.show("Unable to get entry data");return}var s=r.getObject();this._currentEditEntry=s;this._currentEditDay=a;var s=this._currentEditEntry;var a=this._currentEditDay;if(!s||!a){sap.m.MessageToast.show("Unable to edit. Please try again.");return}var o=a+"Hours";var n=a+"TaskDetails";var i=a+"Date";var d=Number(s[o])||0;var l=s[n]||"";var u=this.getView().getModel("timeEntryModel").getProperty("/weekDates");var y=u[a];var c="";if(y){try{var p=new Date(y);c=p.toLocaleDateString("en-US",{month:"short",day:"2-digit",year:"numeric"})}catch(e){console.warn("‚ö† Failed to format date:",y,e);c=""}}var m=[];for(var D=0;D<=15;D++){m.push(new sap.ui.core.Item({key:D.toString(),text:D+" hour"+(D!==1?"s":"")}))}var g=new sap.m.ComboBox({selectedKey:d.toString(),items:m});var h=new sap.m.TextArea({value:l,rows:4,placeholder:"Describe work done..."});var w=new sap.m.Dialog({title:"Edit "+this._capitalize(a)+" Entry",contentWidth:"350px",titleAlignment:"Center",content:[new sap.m.VBox({items:[new sap.m.VBox({items:[new sap.m.Label({text:"Date:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:c,editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Project:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:s.projectName,editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Task Type:",design:"Bold"}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.Input({value:s.workType,editable:false})]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Hours:",design:"Bold",required:true}).addStyleClass("sapUiTinyMarginBottom"),g]}).addStyleClass("sapUiTinyMarginBottom"),new sap.m.VBox({items:[new sap.m.Label({text:"Task Details:",design:"Bold",required:true}).addStyleClass("sapUiTinyMarginBottom"),h.setRows(4).setWidth("100%")]})]}).addStyleClass("sapUiMediumMarginBeginEnd sapUiSmallMarginTopBottom")],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",icon:"sap-icon://save",press:function(){var e=Number(g.getSelectedKey());var t=h.getValue();if(isNaN(e)||e<0||e>24){sap.m.MessageBox.error("Please select valid hours between 0 and 24");return}if(!t){sap.m.MessageBox.warning("Task Details can't be empty. Write what you did");sap.ui.core.BusyIndicator.hide();return}this._saveEditedDayHoursAuto(s,a,e,t);w.close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",icon:"sap-icon://decline",press:function(){w.close()}}),afterClose:function(){w.destroy()}});this.getView().addDependent(w);w.open()},_validateMandatoryFields:function(e){if(!e){sap.m.MessageBox.error("No entry data found.");return false}const t=e.projectId&&e.projectId.trim()!=="";const a=e.nonProjectTypeID&&e.nonProjectTypeID.trim()!=="";if(!t&&!a){sap.m.MessageBox.error("Please select a Project or Non-Project Activity.");return false}if(t){if(!e.workType||e.workType.trim()===""){sap.m.MessageBox.error("Work Type is required when Project is selected.");return false}}let r=parseFloat(e.hours);if(isNaN(r)||r<=0||r>15){sap.m.MessageBox.error("Hours must be between 1 and 15.");return false}if(!e.taskDetails||e.taskDetails.trim()===""){sap.m.MessageBox.error("Please enter Task Details.");return false}return true},_parseODataDate:function(e){if(!e)return null;let t=/\/Date\((\d+)\)\//.exec(e);return t?new Date(parseInt(t[1],10)):null},_loadWeekEntries:function(e){let t=this.getOwnerComponent().getModel("timesheetServiceV2");let a=this.getView().getModel("timeEntryModel");let r=this._formatDateForModel(e);let s=this._formatDateForModel(new Date(e.getFullYear(),e.getMonth(),e.getDate()+6));let o=`weekStartDate eq datetime'${r}T00:00:00' and weekEndDate eq datetime'${s}T00:00:00'`;console.log("Filter:",o);t.read("/MyTimesheets",{urlParameters:{$filter:o},success:function(e){sap.ui.core.BusyIndicator.hide();let t=e.d?.results||e.results||[];let o=t.filter(e=>{let t=e.weekStartDate?new Date(e.weekStartDate).toISOString().split("T")[0]:null;let a=e.weekEndDate?new Date(e.weekEndDate).toISOString().split("T")[0]:null;let o=new Date(r).toISOString().split("T")[0];let n=new Date(s).toISOString().split("T")[0];return t===o&&a===n});let n;if(o.length>0){n=o.map(e=>{let t=e.projectName?e.projectName:e.nonProjectTypeName||"";return{id:e.ID,totalWeekHours:e.totalWeekHours,projectId:e.project_ID,projectName:t,nonProjectType_ID:e.nonProjectType_ID,nonProjectTypeName:e.nonProjectTypeName,workType:e.task||"",status:e.status||"",weekStart:this._parseODataDate(e.weekStartDate),weekEnd:this._parseODataDate(e.weekEndDate),mondayHours:e.mondayHours||0,tuesdayHours:e.tuesdayHours||0,wednesdayHours:e.wednesdayHours||0,thursdayHours:e.thursdayHours||0,fridayHours:e.fridayHours||0,saturdayHours:e.saturdayHours||0,sundayHours:e.sundayHours||0,mondayTaskDetails:e.mondayTaskDetails||"",tuesdayTaskDetails:e.tuesdayTaskDetails||"",wednesdayTaskDetails:e.wednesdayTaskDetails||"",thursdayTaskDetails:e.thursdayTaskDetails||"",fridayTaskDetails:e.fridayTaskDetails||"",saturdayTaskDetails:e.saturdayTaskDetails||"",sundayTaskDetails:e.sundayTaskDetails||"",dates:a.getProperty("/weekDates")}});n.forEach(e=>{e.canDelete=this._checkRowDeleteEligibility(e)})}else{n=[];a.setProperty("/timeEntries",n);a.setProperty("/dailyTotals",{monday:0,tuesday:0,wednesday:0,thursday:0,friday:0,saturday:0,sunday:0});a.setProperty("/totalWeekHours",0);let e=this.getView().byId("timesheetTable");e?.getBinding("items")?.refresh(true)}this._applyWeekData(n)}.bind(this),error:function(e){console.error("Failed to load week entries",e)}.bind(this)})},_applyWeekData:function(e){let t=this.getView().getModel("timeEntryModel");t.setProperty("/timeEntries",e);let a=this._calculateDailyTotals(e);t.setProperty("/dailyTotals",a);let r=Object.values(a).reduce((e,t)=>e+t,0);t.setProperty("/totalWeekHours",r.toFixed(2));let s=this.getView().byId("timesheetTable");s?.getBinding("items")?.refresh(true)},_toODataDate:function(e){return`/Date(${new Date(e).getTime()})/`},_clearWeekEntries:function(){var e=this.getView().getModel("timeEntryModel");var t={monday:0,tuesday:0,wednesday:0,thursday:0,friday:0,saturday:0,sunday:0};e.setProperty("/dailyTotals",t);e.setProperty("/timeEntries",[]);e.setProperty("/totalWeekHours","0.00")},_setDatePicker:function(e){let t=this.byId("datePicker");if(t&&e){t.setDateValue(e)}},onNextWeekTS:function(){var e=this.getView().getModel("timeEntryModel");var t=new Date(e.getProperty("/weekDates/monday"));t.setDate(t.getDate()+7);e.setProperty("/isNextWeek",true);this._currentWeekStartDate=t;sap.ui.core.BusyIndicator.show(0);this._updateWeekDates(t);this._loadWeekEntries(t);this._setDatePicker(t)},onPreviousWeekTS:function(){sap.ui.core.BusyIndicator.show(0);var e=this.getView().getModel("timeEntryModel");var t=new Date(e.getProperty("/weekDates/monday"));t.setDate(t.getDate()-7);e.setProperty("/isNextWeek",false);this._currentWeekStartDate=t;this._updateWeekDates(t);this._loadWeekEntries(t);this._setDatePicker(t)},onCurrentWeekTS:function(){sap.ui.core.BusyIndicator.show(0);var e=this._getCurrentWeekMonday();this._currentWeekStartDate=e;this._updateWeekDates(e);this._loadWeekEntries(e);this._setDatePicker(e)},_updateDailyTotals:function(){var e=this.getView().getModel("timeEntryModel");var t=e.getProperty("/timeEntries")||[];var a={monday:0,tuesday:0,wednesday:0,thursday:0,friday:0,saturday:0,sunday:0};t.forEach(function(e){a.monday+=e.monday||0;a.tuesday+=e.tuesday||0;a.wednesday+=e.wednesday||0;a.thursday+=e.thursday||0;a.friday+=e.friday||0;a.saturday+=e.saturday||0;a.sunday+=e.sunday||0});e.setProperty("/dailyTotals",a)},onDatePickerChange:function(e){sap.ui.core.BusyIndicator.show(0);let t=e.getSource().getDateValue();if(!t)return;let a=t.getDay();let r=new Date(t);r.setDate(t.getDate()-(a===0?6:a-1));this._updateWeekDates(r);this._loadWeekEntries(r)},_updateWeekDates:function(e){var t=this.getView().getModel("timeEntryModel");var a=this._getMonday(e);var r={};["monday","tuesday","wednesday","thursday","friday","saturday","sunday"].forEach((e,t)=>{let s=new Date(a);s.setDate(s.getDate()+t);r[e]=this._formatDateForModel(s);r[e+"Formatted"]=this._formatDateDisplay(s);r[e+"IsFuture"]=s>new Date});t.setProperty("/weekDates",r);var s=r.mondayFormatted+" - "+r.sundayFormatted+" "+a.getFullYear();t.setProperty("/currentWeek",s);var o=new Date;t.setProperty("/isCurrentWeek",o>=a&&o<=new Date(a.getTime()+6*24*60*60*1e3))},_getMonday:function(e){var t=e.getDay();var a=e.getDate()-t+(t===0?-6:1);var r=new Date(e);r.setDate(a);r.setHours(0,0,0,0);return r},_formatDateDisplay:function(e){var t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return t[e.getMonth()]+" "+("0"+e.getDate()).slice(-2)},onTaskDetailPress:function(e){try{var t=e.getSource();var a=t.getBindingContext("timeEntryModel");if(!a){sap.m.MessageToast.show("Unable to get binding context");return}var r=a.getObject();var s=this.getView().getModel("timeEntryModel");var o=s.getProperty("/weekDates");if(!o){sap.m.MessageToast.show("Week dates not available");return}r.dailyComments=r.dailyComments||{};var n=this;var i=[{name:"Monday",hours:r.mondayHours||0,comment:r.mondayTaskDetails||"No task details",date:n._formatDateForDisplay(o.monday)},{name:"Tuesday",hours:r.tuesdayHours||0,comment:r.tuesdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.tuesday)},{name:"Wednesday",hours:r.wednesdayHours||0,comment:r.wednesdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.wednesday)},{name:"Thursday",hours:r.thursdayHours||0,comment:r.thursdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.thursday)},{name:"Friday",hours:r.fridayHours||0,comment:r.fridayTaskDetails||"No task details",date:n._formatDateForDisplay(o.friday)},{name:"Saturday",hours:r.saturdayHours||0,comment:r.saturdayTaskDetails||"No task details",date:n._formatDateForDisplay(o.saturday)},{name:"Sunday",hours:r.sundayHours||0,comment:r.sundayTaskDetails||"No task details",date:n._formatDateForDisplay(o.sunday)}];var d=function(e){if(e===0){return"tsHoursRed"}else if(e>0&&e<8){return"tsHoursOrange"}else if(e>=8&&e<=15){return"tsHoursGreen"}return""};var l=i.map(function(e,t){return new sap.m.VBox({width:"100%",items:[new sap.m.HBox({justifyContent:"SpaceBetween",items:[new sap.m.Text({text:`${e.name} (${e.date})`,design:"Bold"}),new sap.m.Text({text:`${e.hours} hrs`,design:"Bold"}).addStyleClass(d(e.hours))]}).addStyleClass("tsDayHeader"),new sap.m.Text({text:e.comment,wrapping:true}).addStyleClass("tsDayComment"),...t<i.length-1?[(new sap.m.ToolbarSeparator).addStyleClass("tsSeparator")]:[]]}).addStyleClass("tsDayCard")});var u=new sap.m.Dialog({title:"Week Task Details",contentWidth:"300px",contentHeight:"70vh",stretchOnPhone:true,content:new sap.m.VBox({items:l}),endButton:new sap.m.Button({text:"Close",press:function(){u.close()}}),afterClose:function(){u.destroy()}});this.getView().addDependent(u);u.open()}catch(e){console.error("Error in onTaskDetailPress:",e)}},onProjectSelect:function(e){var t=e.getParameter("listItem");if(t){var a=t.getBindingContext().getObject();i.show("Selected project: "+a.projectName+" (Manager: "+a.managerName+")")}},onProfilePress:function(){var e=this.getOwnerComponent().getModel("timesheetServiceV2");var t=this.getView();if(!e){sap.m.MessageBox.error("OData model not found. Please check your manifest configuration.");return}sap.ui.core.BusyIndicator.show(0);e.read("/MyProfile",{success:function(e){sap.ui.core.BusyIndicator.hide();if(!e||!e.results||!e.results.length){sap.m.MessageBox.warning("No profile data found.");return}var a=e.results[0];var r={employeeID:a.employeeID||"",firstName:a.firstName||"",lastName:a.lastName||"",email:a.email||"",managerName:a.managerName||"",managerEmail:a.managerEmail||"",activeStatus:a.isActive?"Yes":"No",changedBy:a.modifiedBy||"",userRole:a.roleName||""};var s=new sap.ui.model.json.JSONModel({profile:r});if(!this._oProfileDialog){this._oProfileDialog=sap.ui.xmlfragment(this.createId("profileDialogFrag"),"employee.Fragments.ProfileDialog",this);t.addDependent(this._oProfileDialog)}this._oProfileDialog.setModel(s,"view");this._oProfileDialog.open()}.bind(this),error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Failed to load profile data.");console.error("Profile load error:",e)}})},onCloseProfileDialog:function(){if(this._oProfileDialog){this._oProfileDialog.close()}},onInfoPress:function(){var e=this.getView();if(!this._oCommentOptionsDialog){this._oCommentOptionsDialog=sap.ui.xmlfragment(e.getId(),"employee.Fragments.CommentOptions",this);e.addDependent(this._oCommentOptionsDialog)}this._initializeCommentData();this._oCommentOptionsDialog.open()},_initializeCommentData:function(){var e=this.getView().getModel();e.setProperty("/currentCommentType","daily");e.setProperty("/selectedDay","monday");e.setProperty("/dailyCommentText","");e.setProperty("/weeklyCommentText","");e.setProperty("/monthlyCommentText","");e.setProperty("/newCommentText","");e.setProperty("/needInput",false);var t=e.getProperty("/projects");var a=e.getProperty("/workTypes");if(t&&t.length>0){e.setProperty("/selectedProject",t[0].id)}if(a&&a.length>0){e.setProperty("/selectedWorkType",a[0].type)}e.setProperty("/selectedStatus","todo");e.setProperty("/selectedPriority","medium");var r=new Date;var s=r.getFullYear()+"-"+("0"+(r.getMonth()+1)).slice(-2)+"-"+("0"+r.getDate()).slice(-2);e.setProperty("/dueDateStart",s);e.setProperty("/dueDateEnd",s)},onSettingsPress:function(){d.information("Timesheet Settings:\n\n- Working hours: 8 hours/day\n- Future bookings allowed for Leave/Training only\n- Manager notifications for approved entry changes")},onViewReports:function(){var e=this.getOwnerComponent().getModel("timesheetServiceV2");if(!e){sap.m.MessageBox.error("OData model not found. Fix your manifest my dude.");return}sap.ui.core.BusyIndicator.show(0);e.read("/BookedHoursOverview",{success:function(e){sap.ui.core.BusyIndicator.hide();if(!e||!e.results||!e.results.length){sap.m.MessageBox.warning("Bro, no booked hours data found.");return}let t=e.results;let a="üìä Project Booked Hours Report\n\n";t.forEach(function(e){a+="üìå Project: "+e.Project+"\n";a+="üïí Allocated Hours: "+e.AllocatedHours+"\n";a+="‚è±Ô∏è Booked Hours: "+e.BookedHours+"\n";a+="üí° Remaining Hours: "+e.RemainingHours+"\n";a+="üìà Utilization: "+e.Utilization+"\n";a+="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"});sap.m.MessageBox.information(a,{title:"Booked Hours Overview"})},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageBox.error("Failed to load Booked Hours Overview.");console.error("OData Error: ",e)}})},_formatODataDate:function(e){if(!e)return"";if(typeof e==="string"&&e.indexOf("/Date(")===0){var t=parseInt(e.replace(/\/Date\((\d+)\)\//,"$1"),10);e=new Date(t)}if(e instanceof Date){var a=("0"+e.getDate()).slice(-2);var r=("0"+(e.getMonth()+1)).slice(-2);var s=e.getFullYear();return a+"-"+r+"-"+s}return""}})});
//# sourceMappingURL=Employee.controller.js.map